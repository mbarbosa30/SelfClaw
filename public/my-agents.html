<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Agents | SelfClaw</title>
  <meta name="description" content="Manage your verified agents, track costs vs revenue, monitor runway, and fund your agents from one dashboard.">
  <link rel="canonical" href="https://selfclaw.ai/my-agents">

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://selfclaw.ai/my-agents">
  <meta property="og:title" content="My Agents | SelfClaw">
  <meta property="og:description" content="Manage your verified agents, track costs vs revenue, monitor runway, and fund your agents from one dashboard.">
  <meta property="og:image" content="https://selfclaw.ai/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="675">
  <meta property="og:site_name" content="SelfClaw">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@mbarrbosa">
  <meta name="twitter:title" content="My Agents | SelfClaw">
  <meta name="twitter:description" content="Manage your verified agents, track costs vs revenue, monitor runway, and fund your agents from one dashboard.">
  <meta name="twitter:image" content="https://selfclaw.ai/og-image.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
  <style>
    .auth-gate {
      text-align: center; padding: 4rem 1rem;
    }
    .auth-gate h2 { margin-bottom: 1rem; }
    .auth-gate p { color: var(--text-secondary); margin-bottom: 2rem; }
    .auth-gate-btn {
      display: inline-block; padding: 0.75rem 2rem;
      background: var(--accent); color: #fff; border: none;
      font-family: var(--font-mono); font-size: 0.85rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer;
    }
    .auth-gate-btn:hover { background: var(--accent-hover); color: #fff; }

    .totals-bar {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
      margin-bottom: var(--space-md);
    }
    @media (max-width: 600px) { .totals-bar { grid-template-columns: repeat(2, 1fr); } }

    .total-card {
      border: 2px solid var(--border-heavy); padding: 1rem;
      border-top: 3px solid var(--green-verify);
    }
    .total-label {
      font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }
    .total-value {
      font-size: 1.5rem; font-weight: 700; color: var(--text);
    }
    .total-value.positive { color: var(--green-verify); }
    .total-value.negative { color: var(--red); }

    .alerts-section {
      border: 2px solid var(--red); padding: 1rem; margin-bottom: var(--space-md);
      display: none;
    }
    .alerts-title {
      font-family: var(--font-mono); font-size: 0.7rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--red);
      margin-bottom: 0.75rem;
    }
    .alert-item {
      font-size: 0.85rem; padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .alert-item:last-child { border-bottom: none; }
    .alert-agent { font-family: var(--font-mono); font-weight: 600; font-size: 0.8rem; }
    .alert-msg { color: var(--text-secondary); }
    .alert-date { font-size: 0.7rem; color: var(--text-muted); }

    .agent-cards { display: flex; flex-direction: column; gap: 1rem; }

    .agent-card {
      border: 2px solid var(--border-heavy); padding: 1.25rem;
      transition: border-color 0.2s;
    }
    .agent-card:hover { border-color: var(--green-verify); }

    .agent-card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;
    }
    .agent-card-name {
      font-size: 1.1rem; font-weight: 700;
    }
    .agent-card-name a { color: var(--text); }
    .agent-card-name a:hover { color: var(--accent); }
    .agent-card-badge {
      font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600;
      padding: 0.15rem 0.5rem; text-transform: uppercase; letter-spacing: 0.08em;
    }
    .badge-profitable { background: var(--green-light); color: var(--green-verify); border: 1px solid var(--green-verify); }
    .badge-deficit { background: rgba(239,68,68,0.08); color: var(--red); border: 1px solid var(--red); }
    .badge-neutral { background: rgba(0,0,0,0.04); color: var(--text-muted); border: 1px solid var(--border); }

    .agent-card-stats {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 500px) { .agent-card-stats { grid-template-columns: repeat(2, 1fr); } }

    .agent-stat-label {
      font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);
    }
    .agent-stat-value {
      font-size: 1rem; font-weight: 600; margin-top: 0.15rem;
    }

    .agent-card-meta {
      display: flex; gap: 1rem; flex-wrap: wrap;
      font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted);
    }
    .meta-item { display: flex; align-items: center; gap: 0.3rem; }
    .meta-dot {
      width: 6px; height: 6px; flex-shrink: 0;
    }
    .meta-dot.active { background: var(--green-verify); }
    .meta-dot.inactive { background: var(--border); }

    .agent-status-summary {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem 1rem;
      padding: 1rem; margin-bottom: 1rem;
      border: 2px solid var(--border-heavy); background: rgba(0,0,0,0.02);
    }
    @media (max-width: 600px) { .agent-status-summary { grid-template-columns: repeat(2, 1fr); } }
    .status-item {}
    .status-item-label {
      font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);
      margin-bottom: 0.15rem;
    }
    .status-item-value {
      font-family: var(--font-mono); font-size: 0.8rem; font-weight: 600;
      color: var(--text); word-break: break-all;
    }
    .status-item-value a { color: var(--accent); }
    .status-item-value .not-set { color: var(--text-muted); font-weight: 400; font-size: 0.75rem; }

    .agent-card-actions {
      display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;
    }
    .action-btn {
      padding: 0.4rem 1rem; border: 2px solid var(--border-heavy);
      background: transparent; font-family: var(--font-mono);
      font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.06em; cursor: pointer; color: var(--text);
      text-decoration: none;
    }
    .action-btn:hover { border-color: var(--green-verify); color: var(--text); }
    .action-btn.primary {
      background: var(--accent); color: #fff; border-color: var(--accent);
    }
    .action-btn.primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); color: #fff; }

    .empty-state {
      text-align: center; padding: 3rem 1rem;
      border: 2px dashed var(--border);
    }
    .empty-state h3 { margin-bottom: 0.5rem; }
    .empty-state p { color: var(--text-secondary); margin-bottom: 1.5rem; }

    .loading-state {
      text-align: center; padding: 3rem;
      font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted);
    }

    .economy-pipeline {
      margin: 1rem 0;
      padding: 1rem 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    .pipeline-label {
      font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }
    .pipeline-steps {
      display: flex; align-items: flex-start; gap: 0;
      position: relative;
    }
    .pipeline-step {
      flex: 1; text-align: center; position: relative;
      min-width: 0;
    }
    .pipeline-step-indicator {
      width: 28px; height: 28px; margin: 0 auto 0.4rem;
      border: 2px solid var(--border); display: flex;
      align-items: center; justify-content: center;
      font-family: var(--font-mono); font-size: 0.7rem; font-weight: 600;
      color: var(--text-muted); background: var(--bg);
      position: relative; z-index: 2;
    }
    .pipeline-step.done .pipeline-step-indicator {
      border-color: var(--green-verify); background: var(--green-verify); color: #fff;
    }
    .pipeline-step.active .pipeline-step-indicator {
      border-color: var(--accent); color: var(--accent); background: var(--accent-light);
    }
    .pipeline-step-label {
      font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    .pipeline-step.done .pipeline-step-label { color: var(--green-verify); }
    .pipeline-step.active .pipeline-step-label { color: var(--accent); }
    .pipeline-step-info {
      font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-muted);
      word-break: break-all; padding: 0 0.15rem;
    }
    .pipeline-step-info a { color: var(--accent); }
    .pipeline-connector {
      position: absolute; top: 14px; left: calc(50% + 14px);
      right: calc(-50% + 14px); height: 2px; background: var(--border);
      z-index: 1;
    }
    .pipeline-step.done .pipeline-connector { background: var(--green-verify); }
    .pipeline-step:last-child .pipeline-connector { display: none; }
    .pipeline-step-action { margin-top: 0.35rem; }
    .pipeline-step-action .action-btn {
      font-size: 0.6rem; padding: 0.25rem 0.5rem;
    }
    .pipeline-step-action .action-btn.primary {
      background: var(--accent); color: #fff; border-color: var(--accent);
    }
    .pipeline-step-action .action-btn:disabled {
      opacity: 0.5; cursor: not-allowed;
    }
    @media (max-width: 600px) {
      .pipeline-steps { flex-wrap: wrap; gap: 0.5rem; }
      .pipeline-step { flex: none; width: calc(33.33% - 0.35rem); }
      .pipeline-connector { display: none; }
    }

    .pipeline-inline-form {
      margin-top: 0.5rem; text-align: left;
      border: 2px solid var(--border-heavy); padding: 0.75rem;
      background: var(--bg-card);
    }
    .pipeline-inline-form .form-row {
      margin-bottom: 0.5rem;
    }
    .pipeline-inline-form label {
      display: block; font-family: var(--font-mono); font-size: 0.6rem;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--text-muted); margin-bottom: 0.15rem;
    }
    .pipeline-inline-form input {
      width: 100%; padding: 0.35rem 0.5rem; border: 2px solid var(--border);
      font-family: var(--font-mono); font-size: 0.75rem; background: var(--bg);
      color: var(--text);
    }
    .pipeline-inline-form input:focus { outline: none; border-color: var(--text); }
    .pipeline-form-actions {
      display: flex; gap: 0.4rem; margin-top: 0.5rem;
    }

    .pipeline-msg {
      font-family: var(--font-mono); font-size: 0.65rem; margin-top: 0.3rem;
      padding: 0.25rem 0.4rem;
    }
    .pipeline-msg.error { color: var(--red); background: rgba(239,68,68,0.06); }
    .pipeline-msg.success { color: var(--green-verify); background: var(--green-light); }
    .pipeline-msg.info { color: var(--text-secondary); background: rgba(0,0,0,0.03); }

    .token-economy-panel {
      border: 2px solid var(--border-heavy); padding: 1rem; margin-top: 0.75rem;
      background: rgba(0,0,0,0.015);
    }
    .token-economy-title {
      font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary);
      margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;
    }
    .token-economy-title .token-symbol {
      color: var(--accent); font-size: 0.8rem;
    }
    .token-economy-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;
    }
    @media (max-width: 600px) { .token-economy-grid { grid-template-columns: repeat(2, 1fr); } }
    .token-econ-item {}
    .token-econ-label {
      font-family: var(--font-mono); font-size: 0.55rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);
      margin-bottom: 0.15rem;
    }
    .token-econ-value {
      font-size: 0.95rem; font-weight: 700; color: var(--text);
    }
    .token-econ-value.accent { color: var(--accent); }
    .token-econ-value.green { color: var(--green-verify); }
    .token-econ-sub {
      font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-muted);
      margin-top: 0.1rem;
    }

    .setup-guide {
      border: 2px solid var(--border); padding: 1rem; margin-top: 0.75rem;
      background: rgba(255,107,74,0.03);
    }
    .setup-guide-title {
      font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent);
      margin-bottom: 0.5rem;
    }
    .setup-guide-step {
      display: flex; gap: 0.5rem; margin-bottom: 0.5rem;
      font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;
    }
    .setup-guide-step:last-child { margin-bottom: 0; }
    .setup-guide-num {
      font-family: var(--font-mono); font-weight: 700; color: var(--accent);
      font-size: 0.75rem; flex-shrink: 0; width: 1.2rem;
    }
    .setup-guide-step.done { color: var(--text-muted); }
    .setup-guide-step.done .setup-guide-num { color: var(--green-verify); }

    .pk-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 10000;
      display: flex; align-items: center; justify-content: center;
    }
    .pk-modal {
      background: var(--bg); border: 2px solid var(--border-heavy);
      padding: 2rem; max-width: 500px; width: 90%;
    }
    .pk-modal-title {
      font-family: var(--font-mono); font-size: 0.75rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--red);
      margin-bottom: 1rem;
    }
    .pk-modal-warning {
      font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5;
      margin-bottom: 1rem;
    }
    .pk-modal-key {
      font-family: var(--font-mono); font-size: 0.75rem; background: var(--bg-code);
      color: #e8e8e8; padding: 0.75rem; word-break: break-all; margin-bottom: 1rem;
      border: 2px solid var(--border-heavy);
    }
    .pk-modal-address {
      font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted);
      margin-bottom: 1rem;
    }
    .pk-modal-actions {
      display: flex; gap: 0.5rem; flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="site-container">
    <header class="site-header">
      <a href="/" class="site-logo"><img src="/claw-icon.svg" alt="" class="site-logo-icon">SELFCLAW</a>
      <button class="nav-toggle" aria-label="Menu">&equiv;</button>
      <nav class="site-nav">
        <a href="/verify" class="nav-link">VERIFY</a>
        <a href="/registry" class="nav-link" data-gate style="display:none">AGENTS</a>
        <a href="/dashboard" class="nav-link" data-gate style="display:none">DASHBOARD</a>
        <a href="/developers" class="nav-link">DOCS</a>
        <a href="/whitepaper" class="nav-link">WHITEPAPER</a>
        <a href="/manifesto" class="nav-link">\\\</a>
      </nav>
    </header>

    <section class="hero" id="hero-section">
      <div class="hero-label" id="hero-label">Agent Dashboard</div>
      <h1 id="hero-title">My Agents</h1>
      <p class="hero-sub" id="hero-sub">Manage your verified agents, track economics, and fund operations.</p>
    </section>

    <div id="auth-gate" class="auth-gate" style="display:none;">
      <h2 id="auth-gate-title">Login Required</h2>
      <p id="auth-gate-desc">Scan the QR code with the Self app to access your agent dashboard.</p>
      <button class="auth-gate-btn" id="login-trigger">Login with Self</button>
    </div>

    <div id="dashboard-loading" class="loading-state" style="display:none;">
      Loading your agents...
    </div>

    <div id="dashboard-content" style="display:none;">
      <div class="totals-bar" id="totals-bar"></div>
      <div class="alerts-section" id="alerts-section">
        <div class="alerts-title">Fund Alerts</div>
        <div id="alerts-list"></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div style="font-family:var(--font-mono);font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-secondary);">Your Agents</div>
      </div>
      <div class="agent-cards" id="agent-cards"></div>
    </div>

    <div id="hosted-section" style="display:none;margin-top:2rem;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div style="font-family:var(--font-mono);font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-secondary);">Miniclaws</div>
        <a href="/create-assistant" style="font-family:var(--font-mono);font-size:0.7rem;color:var(--accent);font-weight:600;text-decoration:none;">+ CREATE</a>
      </div>
      <div id="hosted-cards" style="display:grid;grid-template-columns:1fr;gap:1rem;"></div>
    </div>

    <div id="empty-state" class="empty-state" style="display:none;">
      <h3>No Agents Yet</h3>
      <p>Verify your agent's public key or create a miniclaw to get started.</p>
      <div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;">
        <a href="/verify" class="action-btn primary">Verify an Agent</a>
        <a href="/create-assistant" class="action-btn" style="background:var(--green-verify);color:#fff;border-color:var(--green-verify);">Create Miniclaw</a>
      </div>
    </div>

    <footer class="site-footer">
      <nav class="footer-nav">
        <a href="/">Home</a>
        <a href="/verify">Verify</a>
        <a href="/registry" data-gate-footer style="display:none">Agents</a>
        <a href="/dashboard" data-gate-footer style="display:none">Dashboard</a>
        <a href="/economy">Economy</a>
        <a href="/developers">Docs</a>
        <a href="/whitepaper">Whitepaper</a>
      </nav>
      <div class="footer-meta">
        <span>Powered by <a href="https://self.xyz" target="_blank">Self.xyz</a> zero-knowledge proofs</span>
        <span>Built by <a href="https://zeno.vision" target="_blank" rel="noopener">Zeno</a> · <a href="https://github.com/mbarbosa30/SelfClaw" target="_blank" rel="noopener">GitHub</a> · <a href="https://t.me/+GC2quXBnarw1MzU0" target="_blank" rel="noopener">Telegram</a> &middot; <a href="https://x.com/selfclaw" target="_blank" rel="noopener">X</a></span>
      </div>
    </footer>
  </div>

  <script src="/auth.js"></script>
  <script src="/nav-gate.js"></script>
  <script>
    function esc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function fmt$(n) { return n >= 0 ? '$' + n.toFixed(2) : '-$' + Math.abs(n).toFixed(2); }
    function fmtDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    function truncKey(k) { if (!k) return ''; return k.substring(0, 10) + '...' + k.slice(-6); }
    function truncAddr(a) { if (!a) return ''; return a.substring(0, 6) + '...' + a.slice(-4); }
    function fmtPrice(n) {
      if (n == null || isNaN(n)) return '—';
      if (n === 0) return '0';
      if (n < 0.000001) return n.toExponential(2);
      if (n < 0.01) return n.toFixed(6);
      if (n < 1) return n.toFixed(4);
      if (n < 1000) return n.toFixed(2);
      return n.toLocaleString('en-US', { maximumFractionDigits: 2 });
    }
    function fmtMcap(n) {
      if (n == null || isNaN(n) || n === 0) return '$0';
      if (n < 1000) return '$' + n.toFixed(2);
      if (n < 1000000) return '$' + (n / 1000).toFixed(1) + 'K';
      return '$' + (n / 1000000).toFixed(2) + 'M';
    }
    function pkStorageKey(pubKey) { return 'wallet_pk_' + (pubKey || '').substring(0, 16); }

    var _dashboardData = null;

    var _isMiniPayContext = false;

    function detectMiniPayContext() {
      if (window.selfclawAuth && window.selfclawAuth.isMiniPay && window.selfclawAuth.isMiniPay()) return true;
      if (window.ethereum && (window.ethereum.isMiniPay || window.ethereum.isMinipay)) return true;
      if (navigator.userAgent && navigator.userAgent.indexOf('MiniPay') !== -1) return true;
      return false;
    }

    function applyMiniPayUI() {
      _isMiniPayContext = true;
      var heroLabel = document.getElementById('hero-label');
      var heroTitle = document.getElementById('hero-title');
      var heroSub = document.getElementById('hero-sub');
      if (heroLabel) heroLabel.textContent = 'Miniclaw Dashboard';
      if (heroTitle) heroTitle.textContent = 'My Miniclaws';
      if (heroSub) heroSub.textContent = 'Create and manage your personal AI assistants.';

      var gateTitle = document.getElementById('auth-gate-title');
      var gateDesc = document.getElementById('auth-gate-desc');
      var loginBtn = document.getElementById('login-trigger');
      if (gateTitle) gateTitle.textContent = 'Connect Wallet';
      if (gateDesc) gateDesc.textContent = 'Connect your MiniPay wallet to manage your miniclaws.';
      if (loginBtn) loginBtn.textContent = 'Connect MiniPay';
    }

    window.onAuthLogin = function(user) { loadDashboard(user); };
    window.onAuthLogout = function() { showAuthGate(); };

    function showAuthGate() {
      document.getElementById('auth-gate').style.display = '';
      document.getElementById('dashboard-loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('hosted-section').style.display = 'none';
      if (detectMiniPayContext()) applyMiniPayUI();
    }

    function showLoading() {
      document.getElementById('auth-gate').style.display = 'none';
      document.getElementById('dashboard-loading').style.display = '';
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';
    }

    async function loadDashboard(user) {
      if (!user || !user.humanId) { showAuthGate(); return; }
      if (detectMiniPayContext()) applyMiniPayUI();
      showLoading();

      try {
        var [res, hostedRes] = await Promise.all([
          fetch('/api/selfclaw/v1/human/' + encodeURIComponent(user.humanId) + '/economics', { credentials: 'include' }),
          fetch('/api/selfclaw/v1/hosted-agents', { credentials: 'include' }).catch(function() { return { ok: false, json: function() { return { agents: [] }; } }; })
        ]);

        var hostedAgents = [];
        if (hostedRes.ok) {
          var hData = await hostedRes.json();
          hostedAgents = hData.agents || [];
        }

        if (!res.ok) throw new Error('Failed to load');
        var data = await res.json();
        _dashboardData = data;

        var hasVerifiedAgents = data.agents && data.agents.length > 0;

        if (!hasVerifiedAgents && hostedAgents.length === 0) {
          document.getElementById('dashboard-loading').style.display = 'none';
          var emptyEl = document.getElementById('empty-state');
          if (_isMiniPayContext) {
            emptyEl.innerHTML = '<h3>No Miniclaws Yet</h3>' +
              '<p>Create your first personal AI assistant — no technical setup needed.</p>' +
              '<div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;">' +
              '<a href="/create-assistant" class="action-btn primary" style="background:var(--green-verify);border-color:var(--green-verify);">Create Miniclaw</a>' +
              '</div>';
          }
          emptyEl.style.display = '';
          return;
        }

        if (hostedAgents.length > 0) {
          renderHostedAgents(hostedAgents);
        }

        if (!hasVerifiedAgents) {
          document.getElementById('dashboard-loading').style.display = 'none';
          if (hostedAgents.length > 0) {
            document.getElementById('hosted-section').style.display = '';
          }
          if (_isMiniPayContext) {
            document.getElementById('dashboard-content').style.display = 'none';
          }
          return;
        }

        renderDashboard(data);

        if (_isMiniPayContext && hostedAgents.length > 0) {
          var hostedEl = document.getElementById('hosted-section');
          var dashContent = document.getElementById('dashboard-content');
          if (hostedEl && dashContent && hostedEl.parentNode) {
            hostedEl.parentNode.insertBefore(hostedEl, dashContent);
          }
        }
      } catch (err) {
        document.getElementById('dashboard-loading').style.display = 'none';
        document.getElementById('dashboard-content').innerHTML = '<div class="empty-state"><h3>Error</h3><p>' + esc(err.message) + '</p></div>';
        document.getElementById('dashboard-content').style.display = '';
      }
    }

    function getStepStatus(agent) {
      var steps = [];
      var hasWallet = agent.wallet !== null && agent.wallet !== undefined;
      var hasGas = hasWallet && agent.wallet.gasReceived;
      var hasErc8004 = agent.erc8004 !== null && agent.erc8004 !== undefined;
      var hasToken = agent.token !== null && agent.token !== undefined;
      var hasSponsorship = agent.sponsorship !== null && agent.sponsorship !== undefined;
      var poolAddr = (hasToken && agent.token.poolAddress) || (hasSponsorship && agent.sponsorship.poolAddress) || null;
      var hasPool = !!poolAddr;

      steps.push({ key: 'wallet', label: 'Wallet', done: hasWallet });
      steps.push({ key: 'gas', label: 'Gas', done: hasGas });
      steps.push({ key: 'erc8004', label: 'ERC-8004', done: hasErc8004 });
      steps.push({ key: 'token', label: 'Token', done: hasToken });
      steps.push({ key: 'sponsorship', label: 'Sponsorship', done: hasSponsorship });
      steps.push({ key: 'pool', label: 'Pool', done: hasPool });

      var activeFound = false;
      for (var i = 0; i < steps.length; i++) {
        if (steps[i].done) {
          steps[i].status = 'done';
        } else if (!activeFound) {
          steps[i].status = 'active';
          activeFound = true;
        } else {
          steps[i].status = 'pending';
        }
      }
      return { steps: steps, hasWallet: hasWallet, hasGas: hasGas, hasErc8004: hasErc8004, hasToken: hasToken, hasSponsorship: hasSponsorship, hasPool: hasPool, poolAddr: poolAddr };
    }

    function renderStatusSummary(agent) {
      var html = '<div class="agent-status-summary">';

      html += '<div class="status-item"><div class="status-item-label">Wallet</div><div class="status-item-value">';
      if (agent.wallet) {
        html += '<a href="https://celoscan.io/address/' + esc(agent.wallet.address) + '" target="_blank" title="' + esc(agent.wallet.address) + '">' + esc(truncAddr(agent.wallet.address)) + '</a>';
        if (agent.wallet.gasReceived) html += ' <span style="color:var(--green-verify);font-size:0.6rem;">GAS OK</span>';
      } else {
        html += '<span class="not-set">Not created</span>';
      }
      html += '</div></div>';

      html += '<div class="status-item"><div class="status-item-label">Token</div><div class="status-item-value">';
      if (agent.token) {
        html += '<span style="color:var(--accent);">$' + esc(agent.token.symbol) + '</span> ';
        html += '<a href="https://celoscan.io/address/' + esc(agent.token.address) + '" target="_blank">' + esc(truncAddr(agent.token.address)) + '</a>';
      } else {
        html += '<span class="not-set">Not deployed</span>';
      }
      html += '</div></div>';

      html += '<div class="status-item"><div class="status-item-label">Price (USD)</div><div class="status-item-value">';
      if (agent.token && agent.token.priceUsd != null) {
        html += '<span style="color:var(--accent);font-size:0.95rem;">$' + fmtPrice(agent.token.priceUsd) + '</span>';
      } else if (agent.token && agent.token.priceCelo != null) {
        html += fmtPrice(agent.token.priceCelo) + ' CELO';
      } else {
        html += '<span class="not-set">&mdash;</span>';
      }
      html += '</div></div>';

      html += '<div class="status-item"><div class="status-item-label">Market Cap</div><div class="status-item-value">';
      if (agent.token && agent.token.marketCapUsd != null) {
        html += '<span style="color:var(--green-verify);font-size:0.95rem;">' + fmtMcap(agent.token.marketCapUsd) + '</span>';
      } else {
        html += '<span class="not-set">&mdash;</span>';
      }
      html += '</div></div>';

      html += '<div class="status-item"><div class="status-item-label">ERC-8004 ID</div><div class="status-item-value">';
      if (agent.erc8004) {
        html += '<span style="color:var(--green-verify);">#' + esc(agent.erc8004.tokenId) + '</span>';
      } else {
        html += '<span class="not-set">Not registered</span>';
      }
      html += '</div></div>';

      html += '<div class="status-item"><div class="status-item-label">Pool</div><div class="status-item-value">';
      if (agent.token && agent.token.poolAddress) {
        var isV4 = agent.token.poolVersion === 'v4' || agent.token.poolAddress.length > 42;
        html += '<span style="color:var(--green-verify);">' + (isV4 ? 'V4' : 'V3') + '</span> ';
        if (isV4) {
          html += '<span title="' + esc(agent.token.poolAddress) + '">' + esc(truncAddr(agent.token.poolAddress)) + '</span>';
        } else {
          html += '<a href="https://celoscan.io/address/' + esc(agent.token.poolAddress) + '" target="_blank">' + esc(truncAddr(agent.token.poolAddress)) + '</a>';
        }
      } else if (agent.sponsorship) {
        html += '<span style="color:var(--accent);">' + esc(agent.sponsorship.status || 'Pending') + '</span>';
      } else {
        html += '<span class="not-set">Not active</span>';
      }
      html += '</div></div>';

      html += '</div>';
      return html;
    }

    function renderPipeline(agent, idx) {
      var info = getStepStatus(agent);
      var steps = info.steps;
      var pubKey = agent.publicKey || '';
      var cardId = 'pipeline-' + idx;

      var html = '<div class="economy-pipeline" id="' + cardId + '">';
      html += '<div class="pipeline-label">Economy Pipeline</div>';
      html += '<div class="pipeline-steps">';

      for (var i = 0; i < steps.length; i++) {
        var step = steps[i];
        var cls = 'pipeline-step ' + step.status;
        html += '<div class="' + cls + '">';
        html += '<div class="pipeline-connector"></div>';

        if (step.done) {
          html += '<div class="pipeline-step-indicator">&#10003;</div>';
        } else if (step.status === 'active') {
          html += '<div class="pipeline-step-indicator">' + (i + 1) + '</div>';
        } else {
          html += '<div class="pipeline-step-indicator">' + (i + 1) + '</div>';
        }

        html += '<div class="pipeline-step-label">' + step.label + '</div>';

        if (step.key === 'wallet') {
          if (step.done) {
            html += '<div class="pipeline-step-info"><a href="https://celoscan.io/address/' + esc(agent.wallet.address) + '" target="_blank">' + esc(truncAddr(agent.wallet.address)) + '</a></div>';
          } else if (step.status === 'active') {
            html += '<div class="pipeline-step-action"><button class="action-btn primary" onclick="actionCreateWallet(' + idx + ', this)">Create Wallet</button></div>';
          }
        } else if (step.key === 'gas') {
          if (step.done) {
            html += '<div class="pipeline-step-info" style="color:var(--green-verify);">Funded</div>';
          } else if (step.status === 'active') {
            html += '<div class="pipeline-step-action"><button class="action-btn primary" onclick="actionRequestGas(' + idx + ', this)">Request Gas</button></div>';
          }
        } else if (step.key === 'erc8004') {
          if (step.done) {
            html += '<div class="pipeline-step-info" style="color:var(--green-verify);">ID #' + esc(agent.erc8004.tokenId) + '</div>';
          } else if (step.status === 'active') {
            html += '<div class="pipeline-step-action"><button class="action-btn primary" onclick="actionRegisterErc8004(' + idx + ', this)">Register Identity</button></div>';
          }
        } else if (step.key === 'token') {
          if (step.done) {
            html += '<div class="pipeline-step-info">$' + esc(agent.token.symbol) + ' <a href="https://celoscan.io/address/' + esc(agent.token.address) + '" target="_blank">' + esc(truncAddr(agent.token.address)) + '</a></div>';
          } else if (step.status === 'active') {
            html += '<div class="pipeline-step-action" id="token-action-' + idx + '"><button class="action-btn primary" onclick="showTokenForm(' + idx + ')">Deploy Token</button></div>';
          }
        } else if (step.key === 'sponsorship') {
          if (step.done) {
            html += '<div class="pipeline-step-info" style="color:var(--green-verify);">' + esc(agent.sponsorship.status || 'Active') + '</div>';
          } else if (agent.sponsorshipRequest) {
            var sr = agent.sponsorshipRequest;
            if (sr.status === 'processing') {
              html += '<div class="pipeline-step-info" style="color:#6B4AFF;">Processing...</div>';
            } else if (sr.status === 'failed') {
              html += '<div class="pipeline-step-info" style="color:#FF4A4A;">Failed' + (sr.retryCount > 0 ? ' (retry ' + sr.retryCount + ')' : '') + '</div>';
              html += '<div class="pipeline-step-info" style="font-size:0.65rem;color:#999;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + esc(sr.errorMessage || '') + '">' + esc(sr.errorMessage || 'Unknown error') + '</div>';
              html += '<div class="pipeline-step-info" style="font-size:0.65rem;color:#999;">Admin will retry</div>';
            } else if (sr.status === 'pending') {
              html += '<div class="pipeline-step-info" style="color:var(--accent);">Pending...</div>';
            }
          } else if (step.status === 'active') {
            html += '<div class="pipeline-step-action"><button class="action-btn primary" onclick="actionRequestSponsorship(' + idx + ', this)">Request Sponsorship</button></div>';
          }
        } else if (step.key === 'pool') {
          if (step.done) {
            var pAddr = info.poolAddr;
            var isV4 = pAddr && pAddr.length > 42;
            if (isV4) {
              html += '<div class="pipeline-step-info" title="V4 Pool ID: ' + esc(pAddr) + '">V4: ' + esc(truncAddr(pAddr)) + '</div>';
            } else {
              html += '<div class="pipeline-step-info"><a href="https://celoscan.io/address/' + esc(pAddr) + '" target="_blank">' + esc(truncAddr(pAddr)) + '</a></div>';
            }
          } else if (step.status === 'active') {
            if (info.hasSponsorship) {
              html += '<div class="pipeline-step-info" style="color:var(--accent);">Pending...</div>';
            }
          }
        }

        html += '</div>';
      }

      html += '</div>';
      html += '<div id="pipeline-msg-' + idx + '"></div>';
      html += '</div>';
      return html;
    }

    function showPipelineMsg(idx, msg, type) {
      var el = document.getElementById('pipeline-msg-' + idx);
      if (el) {
        el.innerHTML = '<div class="pipeline-msg ' + (type || 'info') + '">' + esc(msg) + '</div>';
      }
    }

    function clearPipelineMsg(idx) {
      var el = document.getElementById('pipeline-msg-' + idx);
      if (el) el.innerHTML = '';
    }

    function setBtnLoading(btn, loading) {
      if (loading) {
        btn.disabled = true;
        btn.setAttribute('data-orig', btn.textContent);
        btn.textContent = 'Loading...';
      } else {
        btn.disabled = false;
        var orig = btn.getAttribute('data-orig');
        if (orig) btn.textContent = orig;
      }
    }

    function showPkModal(address, privateKey, pubKey) {
      var existing = document.getElementById('pk-modal-overlay');
      if (existing) existing.remove();

      var overlay = document.createElement('div');
      overlay.id = 'pk-modal-overlay';
      overlay.className = 'pk-modal-overlay';

      var modal = document.createElement('div');
      modal.className = 'pk-modal';
      modal.innerHTML = '<div class="pk-modal-title">&#9888; Save Your Private Key</div>' +
        '<div class="pk-modal-warning">This is the <strong>only time</strong> your private key will be shown. Save it somewhere secure. If you lose it, you will lose access to this wallet forever.</div>' +
        '<div class="pk-modal-address">Wallet Address: ' + esc(address) + '</div>' +
        '<div class="pk-modal-key" id="pk-display">' + esc(privateKey) + '</div>' +
        '<div class="pk-modal-actions">' +
        '<button class="action-btn" onclick="copyPkToClipboard()">Copy Key</button>' +
        '<button class="action-btn primary" id="pk-confirm-btn">I\'ve Saved It</button>' +
        '</div>';

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      try {
        localStorage.setItem(pkStorageKey(pubKey), privateKey);
      } catch (e) {}

      document.getElementById('pk-confirm-btn').addEventListener('click', function() {
        overlay.remove();
        reloadCurrentDashboard();
      });

      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.remove();
          reloadCurrentDashboard();
        }
      });
    }

    function copyPkToClipboard() {
      var el = document.getElementById('pk-display');
      if (!el) return;
      var text = el.textContent;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text);
      } else {
        var ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
    }

    function reloadCurrentDashboard() {
      if (window.selfclawAuth && window.selfclawAuth.getUser) {
        var user = window.selfclawAuth.getUser();
        if (user) { loadDashboard(user); return; }
      }
      if (_dashboardData && _dashboardData.humanId) {
        loadDashboard({ humanId: _dashboardData.humanId });
        return;
      }
      window.location.reload();
    }

    function actionCreateWallet(idx, btn) {
      var agents = (_dashboardData && _dashboardData.agents) || [];
      var agent = agents[idx];
      if (!agent) return;
      var pubKey = agent.publicKey;

      setBtnLoading(btn, true);
      clearPipelineMsg(idx);

      fetch('/api/selfclaw/v1/my-agents/' + encodeURIComponent(pubKey) + '/setup-wallet', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        setBtnLoading(btn, false);
        if (data.success && data.address) {
          showPkModal(data.address, data.privateKey || '', pubKey);
        } else {
          showPipelineMsg(idx, data.error || 'Failed to create wallet', 'error');
        }
      })
      .catch(function(err) {
        setBtnLoading(btn, false);
        showPipelineMsg(idx, 'Error: ' + err.message, 'error');
      });
    }

    function actionRequestGas(idx, btn) {
      var agents = (_dashboardData && _dashboardData.agents) || [];
      var agent = agents[idx];
      if (!agent) return;
      var pubKey = agent.publicKey;

      setBtnLoading(btn, true);
      clearPipelineMsg(idx);

      fetch('/api/selfclaw/v1/my-agents/' + encodeURIComponent(pubKey) + '/request-gas', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        setBtnLoading(btn, false);
        if (data.success) {
          showPipelineMsg(idx, 'Gas received! ' + (data.amountCelo || '') + ' CELO sent.', 'success');
          setTimeout(function() { reloadCurrentDashboard(); }, 1500);
        } else {
          showPipelineMsg(idx, data.error || 'Failed to request gas', 'error');
        }
      })
      .catch(function(err) {
        setBtnLoading(btn, false);
        showPipelineMsg(idx, 'Error: ' + err.message, 'error');
      });
    }

    var _sponsorshipCache = null;

    function fetchSponsorshipForForm(callback) {
      if (_sponsorshipCache) { callback(_sponsorshipCache); return; }
      fetch('/api/selfclaw/v1/selfclaw-sponsorship', { credentials: 'include' })
        .then(function(r) { return r.json(); })
        .then(function(data) { _sponsorshipCache = data; callback(data); })
        .catch(function() { callback(null); });
    }

    function updateValuationPreview(idx) {
      var supplyInput = document.getElementById('tf-supply-' + idx);
      var liqInput = document.getElementById('tf-liq-' + idx);
      var previewEl = document.getElementById('tf-valuation-' + idx);
      if (!supplyInput || !liqInput || !previewEl || !_sponsorshipCache) return;

      var supply = parseFloat(supplyInput.value) || 0;
      var liqTokens = parseFloat(liqInput.value) || 0;
      if (supply <= 0 || liqTokens <= 0) { previewEl.textContent = '—'; return; }

      var sponsorable = parseFloat(_sponsorshipCache.available || '0') / 2;
      var selfclawPriceUsd = _sponsorshipCache.selfclawPriceUsd || _sponsorshipCache.halfValueUsd / sponsorable;
      if (sponsorable <= 0 || !selfclawPriceUsd) { previewEl.textContent = 'Price data unavailable'; return; }

      var priceInSelfclaw = sponsorable / liqTokens;
      var priceUsd = priceInSelfclaw * selfclawPriceUsd;
      var mcapUsd = priceUsd * supply;
      var liqPercent = (liqTokens / supply * 100).toFixed(1);
      var poolValueUsd = sponsorable * selfclawPriceUsd * 2;

      var priceStr = priceUsd < 0.001 ? priceUsd.toExponential(2) : priceUsd.toFixed(6);
      var mcapStr = mcapUsd >= 1000 ? '$' + (mcapUsd / 1000).toFixed(1) + 'K' : '$' + mcapUsd.toFixed(2);

      previewEl.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:0.5rem;align-items:baseline;">' +
        '<span style="color:var(--accent);font-weight:700;font-size:1rem;">' + mcapStr + '</span>' +
        '<span style="color:var(--text-muted);font-size:0.7rem;">market cap</span>' +
        '</div>' +
        '<div style="font-size:0.7rem;color:var(--text-secondary);margin-top:0.25rem;">' +
        '$' + priceStr + '/token &middot; ' + liqPercent + '% of supply in liquidity &middot; ~$' + poolValueUsd.toFixed(2) + ' pool value' +
        '</div>';
    }

    function showTokenForm(idx) {
      var container = document.getElementById('token-action-' + idx);
      if (!container) return;

      container.innerHTML = '<div class="pipeline-inline-form">' +
        '<div class="form-row"><label>Token Name</label><input type="text" id="tf-name-' + idx + '" placeholder="My Agent Token"></div>' +
        '<div class="form-row"><label>Symbol</label><input type="text" id="tf-symbol-' + idx + '" placeholder="MAT" maxlength="10"></div>' +
        '<div class="form-row"><label>Total Supply</label><input type="number" id="tf-supply-' + idx + '" placeholder="1000000" value="1000000"></div>' +
        '<div id="tf-sponsor-info-' + idx + '" style="border:2px solid var(--border-heavy);padding:0.75rem;margin-bottom:0.75rem;background:rgba(255,107,74,0.04);">' +
          '<div style="font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.06em;color:var(--text-secondary);margin-bottom:0.4rem;font-weight:600;">YOUR VALUATION</div>' +
          '<div style="display:flex;align-items:baseline;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.5rem;">' +
            '<span id="tf-sp-amount-' + idx + '" style="font-family:var(--font-mono);font-size:1.1rem;font-weight:700;color:var(--text);">...</span>' +
            '<span style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-secondary);">SELFCLAW will be paired (fixed)</span>' +
            '<span id="tf-sp-usd-' + idx + '" style="font-family:var(--font-mono);font-size:0.8rem;color:var(--accent);font-weight:600;"></span>' +
          '</div>' +
          '<div class="form-row" style="margin-bottom:0.5rem;"><label>Tokens for Liquidity</label>' +
            '<input type="number" id="tf-liq-' + idx + '" placeholder="100000" value="100000" style="width:100%;padding:0.35rem 0.5rem;border:2px solid var(--border);font-family:var(--font-mono);font-size:0.75rem;background:var(--bg);color:var(--text);">' +
            '<div style="font-size:0.65rem;color:var(--text-muted);margin-top:0.15rem;">How many of your tokens to pair with SELFCLAW. This sets your initial price and market cap.</div>' +
          '</div>' +
          '<div id="tf-valuation-' + idx + '" style="font-size:0.75rem;color:var(--text-secondary);line-height:1.4;padding:0.5rem;border:1px solid var(--border-light);background:var(--bg);">Loading valuation...</div>' +
        '</div>' +
        '<div id="tf-pk-row-' + idx + '" style="display:none;"><div class="form-row"><label>Wallet Private Key</label><input type="password" id="tf-pk-' + idx + '" placeholder="Paste your wallet private key"></div></div>' +
        '<div class="pipeline-form-actions">' +
        '<button class="action-btn primary" id="tf-submit-' + idx + '">Deploy &amp; Sign</button>' +
        '<button class="action-btn" onclick="cancelTokenForm(' + idx + ')">Cancel</button>' +
        '</div>' +
        '</div>';

      var agents = (_dashboardData && _dashboardData.agents) || [];
      var agent = agents[idx];
      var pubKey = agent ? agent.publicKey : '';
      var storedPk = null;
      try { storedPk = localStorage.getItem(pkStorageKey(pubKey)); } catch (e) {}
      if (!storedPk) {
        var pkRow = document.getElementById('tf-pk-row-' + idx);
        if (pkRow) pkRow.style.display = '';
      }

      document.getElementById('tf-submit-' + idx).addEventListener('click', function() {
        actionDeployToken(idx);
      });

      fetchSponsorshipForForm(function(data) {
        var amountEl = document.getElementById('tf-sp-amount-' + idx);
        var usdEl = document.getElementById('tf-sp-usd-' + idx);
        if (!data || !amountEl) {
          if (amountEl) amountEl.textContent = '—';
          var valEl = document.getElementById('tf-valuation-' + idx);
          if (valEl) valEl.textContent = 'Sponsorship data unavailable';
          return;
        }
        var sponsorable = parseFloat(data.available || '0') / 2;
        amountEl.textContent = Math.floor(sponsorable).toLocaleString();
        if (data.halfValueUsd != null && usdEl) {
          usdEl.textContent = '~$' + data.halfValueUsd.toFixed(2);
        }
        updateValuationPreview(idx);
      });

      var supplyInput = document.getElementById('tf-supply-' + idx);
      var liqInput = document.getElementById('tf-liq-' + idx);
      if (supplyInput) {
        supplyInput.addEventListener('input', function() { updateValuationPreview(idx); });
      }
      if (liqInput) {
        liqInput.addEventListener('input', function() { updateValuationPreview(idx); });
      }
    }

    function cancelTokenForm(idx) {
      var container = document.getElementById('token-action-' + idx);
      if (!container) return;
      container.innerHTML = '<button class="action-btn primary" onclick="showTokenForm(' + idx + ')">Deploy Token</button>';
    }

    function actionDeployToken(idx) {
      var agents = (_dashboardData && _dashboardData.agents) || [];
      var agent = agents[idx];
      if (!agent) return;
      var pubKey = agent.publicKey;

      var nameInput = document.getElementById('tf-name-' + idx);
      var symbolInput = document.getElementById('tf-symbol-' + idx);
      var supplyInput = document.getElementById('tf-supply-' + idx);
      var pkInput = document.getElementById('tf-pk-' + idx);

      var liqInput = document.getElementById('tf-liq-' + idx);

      var tokenName = nameInput ? nameInput.value.trim() : '';
      var tokenSymbol = symbolInput ? symbolInput.value.trim() : '';
      var initialSupply = supplyInput ? supplyInput.value.trim() : '';
      var liquidityTokens = liqInput ? liqInput.value.trim() : '';

      if (!tokenName || !tokenSymbol || !initialSupply) {
        showPipelineMsg(idx, 'Please fill in all token fields', 'error');
        return;
      }

      if (liquidityTokens && parseFloat(liquidityTokens) > 0) {
        var agents2 = (_dashboardData && _dashboardData.agents) || [];
        if (agents2[idx]) agents2[idx]._liquidityTokens = liquidityTokens;
      }

      var walletPk = null;
      try { walletPk = localStorage.getItem(pkStorageKey(pubKey)); } catch (e) {}
      if (!walletPk && pkInput) {
        walletPk = pkInput.value.trim();
      }
      if (!walletPk) {
        showPipelineMsg(idx, 'Wallet private key is required. Paste it in the field above.', 'error');
        var pkRow = document.getElementById('tf-pk-row-' + idx);
        if (pkRow) pkRow.style.display = '';
        return;
      }

      var submitBtn = document.getElementById('tf-submit-' + idx);
      if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Deploying...'; }
      clearPipelineMsg(idx);
      showPipelineMsg(idx, 'Step 1/3: Requesting unsigned transaction...', 'info');

      fetch('/api/selfclaw/v1/my-agents/' + encodeURIComponent(pubKey) + '/deploy-token', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: tokenName, symbol: tokenSymbol, initialSupply: initialSupply })
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        if (!data.success || !data.unsignedTx) {
          showPipelineMsg(idx, data.error || 'Failed to get unsigned transaction', 'error');
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Deploy & Sign'; }
          return;
        }

        showPipelineMsg(idx, 'Step 2/3: Signing and broadcasting transaction...', 'info');

        var unsignedTx = data.unsignedTx;

        if (typeof ethers === 'undefined') {
          showPipelineMsg(idx, 'ethers.js not loaded. Please refresh the page.', 'error');
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Deploy & Sign'; }
          return;
        }

        var provider = new ethers.JsonRpcProvider('https://forno.celo.org');
        var wallet = new ethers.Wallet(walletPk, provider);

        var txReq = { data: unsignedTx.data };
        if (unsignedTx.to) txReq.to = unsignedTx.to;
        if (unsignedTx.value) txReq.value = unsignedTx.value;
        txReq.gasLimit = unsignedTx.gas || unsignedTx.gasLimit;
        if (unsignedTx.gasPrice) txReq.gasPrice = unsignedTx.gasPrice;
        if (unsignedTx.nonce !== undefined && unsignedTx.nonce !== null) txReq.nonce = unsignedTx.nonce;
        if (unsignedTx.chainId) txReq.chainId = unsignedTx.chainId;

        return wallet.sendTransaction(txReq).then(function(txResponse) {
          showPipelineMsg(idx, 'Step 3/3: Waiting for confirmation...', 'info');
          return txResponse.wait().then(function(receipt) {
            var txHash = receipt.hash || txResponse.hash;
            var tokenAddress = receipt.contractAddress || '';

            if (!tokenAddress && receipt.logs && receipt.logs.length > 0) {
              tokenAddress = receipt.logs[0].address || '';
            }

            showPipelineMsg(idx, 'Registering token on SelfClaw...', 'info');

            return fetch('/api/selfclaw/v1/my-agents/' + encodeURIComponent(pubKey) + '/register-token', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ tokenAddress: tokenAddress, txHash: txHash })
            }).then(function(regRes) { return regRes.json(); }).then(function(regData) {
              if (regData.success || regData.token) {
                showPipelineMsg(idx, 'Token deployed! View on Celoscan: ' + truncAddr(tokenAddress), 'success');
                setTimeout(function() { reloadCurrentDashboard(); }, 2000);
              } else {
                showPipelineMsg(idx, 'Token deployed but registration failed: ' + (regData.error || 'Unknown error') + '. TX: ' + txHash, 'error');
              }
            });
          });
        });
      })
      .catch(function(err) {
        showPipelineMsg(idx, 'Error: ' + (err.reason || err.message || String(err)), 'error');
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Deploy & Sign'; }
      });
    }

    function actionRequestSponsorship(idx, btn) {
      var agents = (_dashboardData && _dashboardData.agents) || [];
      var agent = agents[idx];
      if (!agent || !agent.token) return;
      var pubKey = agent.publicKey;

      var liqAmount = agent._liquidityTokens || null;
      if (!liqAmount) {
        var liqPrompt = prompt('How many of your tokens do you want to put in the liquidity pool?\n\nThis sets your initial price and market cap.\nSELFCLAW sponsorship amount is fixed — you control the ratio.\n\nExample: 100000 (for 10% of 1M supply)');
        if (!liqPrompt) return;
        liqAmount = liqPrompt.trim();
      }

      setBtnLoading(btn, true);
      clearPipelineMsg(idx);

      fetch('/api/selfclaw/v1/my-agents/' + encodeURIComponent(pubKey) + '/request-sponsorship', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tokenAddress: agent.token.address,
          tokenSymbol: agent.token.symbol,
          tokenAmount: liqAmount
        })
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        setBtnLoading(btn, false);
        if (data.success || data.pool) {
          showPipelineMsg(idx, 'Sponsorship & liquidity pool created!', 'success');
          setTimeout(function() { reloadCurrentDashboard(); }, 1500);
        } else {
          showPipelineMsg(idx, data.error || 'Sponsorship request failed', 'error');
        }
      })
      .catch(function(err) {
        setBtnLoading(btn, false);
        showPipelineMsg(idx, 'Error: ' + err.message, 'error');
      });
    }

    function renderDashboard(data) {
      document.getElementById('dashboard-loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = '';

      var totals = data.totals || {};
      var net = (totals.revenue || 0) - (totals.costs || 0);
      var netClass = net > 0 ? 'positive' : net < 0 ? 'negative' : '';

      document.getElementById('totals-bar').innerHTML =
        '<div class="total-card"><div class="total-label">Agents</div><div class="total-value">' + (data.agentCount || 0) + '</div></div>' +
        '<div class="total-card"><div class="total-label">Revenue</div><div class="total-value positive">' + fmt$(totals.revenue || 0) + '</div></div>' +
        '<div class="total-card"><div class="total-label">Costs</div><div class="total-value">' + fmt$(totals.costs || 0) + '</div></div>' +
        '<div class="total-card"><div class="total-label">Net P/L</div><div class="total-value ' + netClass + '">' + fmt$(net) + '</div></div>';

      if (data.alerts && data.alerts.length > 0) {
        var alertsSection = document.getElementById('alerts-section');
        alertsSection.style.display = '';
        document.getElementById('alerts-list').innerHTML = data.alerts.map(function(a) {
          return '<div class="alert-item"><span class="alert-agent">' + esc(a.agentName || 'Agent') + '</span> <span class="alert-msg">' + esc(a.message) + '</span> <span class="alert-date">' + fmtDate(a.date) + '</span></div>';
        }).join('');
      }

      var agents = data.agents || [];
      if (agents.length === 0) {
        document.getElementById('agent-cards').innerHTML = '<div class="empty-state"><h3>No agents found</h3><p>Your verified agents will appear here.</p></div>';
        return;
      }

      document.getElementById('agent-cards').innerHTML = agents.map(function(agent, idx) {
        var econ = agent.economics || {};
        var agentNet = (econ.totalRevenue || 0) - (econ.totalCosts || 0);
        var statusClass = agentNet > 0 ? 'badge-profitable' : agentNet < 0 ? 'badge-deficit' : 'badge-neutral';
        var statusText = agentNet > 0 ? 'Profitable' : agentNet < 0 ? 'Deficit' : 'Neutral';
        var name = agent.name || truncKey(agent.publicKey);
        var profileUrl = '/agent/' + encodeURIComponent(name);

        var html = '<div class="agent-card">';
        html += '<div class="agent-card-header">';
        html += '<div class="agent-card-name"><a href="' + profileUrl + '">' + esc(name) + '</a></div>';
        html += '<span class="agent-card-badge ' + statusClass + '">' + statusText + '</span>';
        html += '</div>';

        html += '<div class="agent-card-stats">';
        html += '<div><div class="agent-stat-label">Revenue</div><div class="agent-stat-value" style="color:var(--green-verify)">' + fmt$(econ.totalRevenue || 0) + '</div></div>';
        html += '<div><div class="agent-stat-label">Costs</div><div class="agent-stat-value">' + fmt$(econ.totalCosts || 0) + '</div></div>';
        html += '<div><div class="agent-stat-label">Net</div><div class="agent-stat-value" style="color:' + (agentNet >= 0 ? 'var(--green-verify)' : 'var(--red)') + '">' + fmt$(agentNet) + '</div></div>';
        html += '<div><div class="agent-stat-label">Services</div><div class="agent-stat-value">' + (agent.services || 0) + '</div></div>';
        html += '</div>';

        html += renderStatusSummary(agent);

        html += renderPipeline(agent, idx);

        if (agent.token) {
          html += renderTokenEconomyPanel(agent);
        }

        html += renderSetupGuide(agent);

        html += '<div class="agent-card-meta">';
        html += '<div class="meta-item"><div class="meta-dot active"></div>Verified ' + fmtDate(agent.verifiedAt) + '</div>';
        html += '<div class="meta-item"><div class="meta-dot ' + (agent.wallet ? 'active' : 'inactive') + '"></div>' + (agent.wallet ? 'Wallet active' : 'No wallet') + '</div>';
        html += '<div class="meta-item"><div class="meta-dot ' + (agent.token ? 'active' : 'inactive') + '"></div>' + (agent.token ? '$' + esc(agent.token.symbol) : 'No token') + '</div>';
        html += '</div>';

        html += '<div class="agent-card-actions">';
        html += '<a href="' + profileUrl + '" class="action-btn">View Profile</a>';
        if (agent.wallet) {
          html += '<a href="https://celoscan.io/address/' + encodeURIComponent(agent.wallet.address) + '" target="_blank" class="action-btn">View Wallet</a>';
        }
        if (agent.token && agent.token.poolAddress) {
          if (agent.token.poolVersion === 'v4' || agent.token.poolAddress.length > 42) {
            html += '<span class="action-btn" title="V4 Pool ID: ' + esc(agent.token.poolAddress) + '" style="cursor:default;">V4 Pool Active</span>';
          } else {
            html += '<a href="https://celoscan.io/address/' + encodeURIComponent(agent.token.poolAddress) + '" target="_blank" class="action-btn">View Pool</a>';
          }
        }
        html += '</div>';

        html += '</div>';
        return html;
      }).join('');
    }

    function renderTokenEconomyPanel(agent) {
      var t = agent.token;
      if (!t) return '';
      var html = '<div class="token-economy-panel">';
      html += '<div class="token-economy-title">Token Economy <span class="token-symbol">$' + esc(t.symbol) + '</span></div>';
      html += '<div class="token-economy-grid">';

      html += '<div class="token-econ-item"><div class="token-econ-label">Price (USD)</div>';
      html += '<div class="token-econ-value accent">' + (t.priceUsd != null ? '$' + fmtPrice(t.priceUsd) : '—') + '</div>';
      if (t.priceCelo != null) {
        html += '<div class="token-econ-sub">' + fmtPrice(t.priceCelo) + ' CELO</div>';
      }
      html += '</div>';

      html += '<div class="token-econ-item"><div class="token-econ-label">Market Cap</div>';
      html += '<div class="token-econ-value green">' + (t.marketCapUsd != null ? fmtMcap(t.marketCapUsd) : '—') + '</div>';
      if (t.marketCapCelo != null) {
        html += '<div class="token-econ-sub">' + fmtPrice(t.marketCapCelo) + ' CELO</div>';
      }
      html += '</div>';

      html += '<div class="token-econ-item"><div class="token-econ-label">Total Supply</div>';
      html += '<div class="token-econ-value">' + (t.totalSupply ? Number(t.totalSupply).toLocaleString() : '—') + '</div>';
      html += '</div>';

      html += '<div class="token-econ-item"><div class="token-econ-label">Pool</div>';
      if (t.poolAddress) {
        var isV4 = t.poolVersion === 'v4' || t.poolAddress.length > 42;
        html += '<div class="token-econ-value" style="font-size:0.8rem;">' + (isV4 ? 'V4' : 'V3') + '</div>';
        html += '<div class="token-econ-sub">';
        if (isV4) {
          html += '<span title="' + esc(t.poolAddress) + '">' + truncAddr(t.poolAddress) + '</span>';
        } else {
          html += '<a href="https://celoscan.io/address/' + esc(t.poolAddress) + '" target="_blank" style="color:var(--accent);">' + truncAddr(t.poolAddress) + '</a>';
        }
        html += '</div>';
      } else {
        html += '<div class="token-econ-value">—</div>';
      }
      html += '</div>';

      html += '</div>';

      html += '<div style="margin-top:0.5rem;font-family:var(--font-mono);font-size:0.6rem;color:var(--text-muted);">';
      html += 'Contract: <a href="https://celoscan.io/address/' + esc(t.address) + '" target="_blank" style="color:var(--accent);">' + esc(t.address) + '</a>';
      html += '</div>';

      html += '</div>';
      return html;
    }

    var _guideCounter = 0;
    function renderSetupGuide(agent) {
      var info = getStepStatus(agent);
      if (info.hasPool) return '';

      var guideSteps = [
        { done: info.hasWallet, text: 'Create a wallet for your agent. This is a Celo blockchain wallet that your agent uses to interact on-chain.' },
        { done: info.hasGas, text: 'Request gas (CELO) to fund transaction fees. SelfClaw provides a small gas subsidy to get started.' },
        { done: info.hasErc8004, text: 'Register your agent\'s on-chain identity via ERC-8004. This mints an NFT that represents your agent on the blockchain.' },
        { done: info.hasToken, text: 'Deploy your agent\'s ERC-20 token. Choose a name, symbol, and supply. This token represents your agent\'s economy.' },
        { done: info.hasSponsorship, text: 'Request SELFCLAW sponsorship. SelfClaw pairs your token with SELFCLAW to create initial liquidity.' },
        { done: info.hasPool, text: 'Liquidity pool goes live on Uniswap V4. Your token becomes tradeable and gets a live price and market cap.' },
      ];

      var doneCount = 0;
      var nextIdx = -1;
      for (var i = 0; i < guideSteps.length; i++) {
        if (guideSteps[i].done) doneCount++;
        else if (nextIdx === -1) nextIdx = i;
      }
      if (nextIdx === -1) return '';

      var collapsed = doneCount >= 3;
      var guideId = 'setup-guide-' + (_guideCounter++);

      var html = '<div class="setup-guide" style="' + (collapsed ? 'padding:0.75rem;' : '') + '">';
      html += '<div class="setup-guide-title" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="var body=document.getElementById(\'' + guideId + '\');body.style.display=body.style.display===\'none\'?\'\':\'none\';">';
      html += '<span>Next Step: ' + esc(guideSteps[nextIdx].text.split('.')[0]) + ' (' + doneCount + '/6 done)</span>';
      html += '<span style="font-size:0.8rem;">' + (collapsed ? '&#9660;' : '&#9650;') + '</span>';
      html += '</div>';
      html += '<div id="' + guideId + '" style="' + (collapsed ? 'display:none;' : '') + 'margin-top:0.5rem;">';
      for (var j = 0; j < guideSteps.length; j++) {
        var gs = guideSteps[j];
        var cls = gs.done ? 'setup-guide-step done' : 'setup-guide-step';
        var numLabel = gs.done ? '&#10003;' : (j + 1);
        html += '<div class="' + cls + '">';
        html += '<div class="setup-guide-num">' + numLabel + '</div>';
        html += '<div>' + esc(gs.text) + '</div>';
        html += '</div>';
      }
      html += '</div>';
      html += '</div>';
      return html;
    }

    function actionRegisterErc8004(idx, btn) {
      var agents = (_dashboardData && _dashboardData.agents) || [];
      var agent = agents[idx];
      if (!agent) return;
      var pubKey = agent.publicKey;

      setBtnLoading(btn, true);
      clearPipelineMsg(idx);

      fetch('/api/selfclaw/v1/my-agents/' + encodeURIComponent(pubKey) + '/register-erc8004', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        setBtnLoading(btn, false);
        if (data.success) {
          if (data.mode === 'signed' && data.txHash) {
            showPipelineMsg(idx, 'ERC-8004 registration submitted! TX: ' + data.txHash.substring(0, 14) + '...', 'success');
            setTimeout(function() { confirmErc8004(idx, pubKey, data.txHash); }, 8000);
          } else {
            showPipelineMsg(idx, 'Registration prepared. Sign the transaction with your wallet to complete.', 'info');
          }
        } else {
          showPipelineMsg(idx, data.error || 'Failed to register', 'error');
        }
      })
      .catch(function(err) {
        setBtnLoading(btn, false);
        showPipelineMsg(idx, 'Error: ' + err.message, 'error');
      });
    }

    var _erc8004RetryCount = {};
    function confirmErc8004(idx, pubKey, txHash) {
      var key = pubKey + ':' + txHash;
      _erc8004RetryCount[key] = (_erc8004RetryCount[key] || 0) + 1;
      if (_erc8004RetryCount[key] > 12) {
        showPipelineMsg(idx, 'Confirmation timed out. Reload the page to check status.', 'info');
        return;
      }
      fetch('/api/selfclaw/v1/my-agents/' + encodeURIComponent(pubKey) + '/confirm-erc8004', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ txHash: txHash })
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        if (data.success) {
          showPipelineMsg(idx, 'ERC-8004 identity confirmed! Token #' + data.tokenId, 'success');
          delete _erc8004RetryCount[key];
          setTimeout(function() { reloadCurrentDashboard(); }, 1500);
        } else {
          var attempt = _erc8004RetryCount[key] || 0;
          showPipelineMsg(idx, 'Waiting for confirmation... (attempt ' + attempt + '/12)', 'info');
          setTimeout(function() { confirmErc8004(idx, pubKey, txHash); }, 10000);
        }
      })
      .catch(function() {
        setTimeout(function() { confirmErc8004(idx, pubKey, txHash); }, 10000);
      });
    }

    async function renderHostedAgents(agents) {
      var section = document.getElementById('hosted-section');
      var container = document.getElementById('hosted-cards');
      if (!agents || agents.length === 0) { section.style.display = 'none'; return; }
      section.style.display = '';

      var econData = {};
      await Promise.all(agents.map(async function(agent) {
        try {
          var r = await fetch('/api/selfclaw/v1/miniclaws/' + encodeURIComponent(agent.id) + '/economics', { credentials: 'include' });
          if (r.ok) econData[agent.id] = await r.json();
        } catch(e) {}
      }));

      container.innerHTML = agents.map(function(agent) {
        var skills = (agent.enabledSkills || []);
        var skillNames = skills.join(', ') || 'None';
        var statusColor = agent.status === 'active' ? 'var(--green-verify)' : 'var(--text-muted)';
        var statusLabel = agent.status === 'active' ? 'RUNNING' : agent.status.toUpperCase();
        var lastActive = agent.lastActiveAt ? fmtDate(agent.lastActiveAt) : 'Never';
        var recentTasks = (agent.recentTasks || []);
        var econ = econData[agent.id] || {};
        var hasWallet = !!(econ.wallet);
        var hasGas = hasWallet && econ.wallet.gasReceived;
        var hasErc8004 = !!(econ.erc8004);
        var hasSponsorship = !!(econ.sponsorship);

        var html = '<div style="border:2px solid var(--border-heavy);padding:1.25rem;">';
        html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem;">';
        html += '<div>';
        html += '<div style="font-size:1.5rem;display:inline-block;margin-right:0.5rem;">' + esc(agent.emoji || '🤖') + '</div>';
        html += '<span style="font-family:var(--font-mono);font-size:0.95rem;font-weight:600;">' + esc(agent.name) + '</span>';
        html += '</div>';
        html += '<span style="font-family:var(--font-mono);font-size:0.65rem;font-weight:600;color:' + statusColor + ';letter-spacing:0.08em;">' + statusLabel + '</span>';
        html += '</div>';

        if (agent.description) {
          html += '<div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.75rem;">' + esc(agent.description) + '</div>';
        }

        html += '<div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:0.75rem;">';
        html += '<div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);">Skills: <span style="color:var(--text-primary);">' + esc(skillNames) + '</span></div>';
        html += '<div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);">Last active: <span style="color:var(--text-primary);">' + lastActive + '</span></div>';
        html += '</div>';

        html += '<div style="border-top:1px solid var(--border-light);padding-top:0.75rem;margin-top:0.5rem;">';
        html += '<div style="font-family:var(--font-mono);font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:0.5rem;">Economy Pipeline</div>';
        html += '<div style="display:flex;gap:0.35rem;flex-wrap:wrap;margin-bottom:0.75rem;">';
        var steps = [
          { key: 'wallet', label: 'Wallet', done: hasWallet },
          { key: 'gas', label: 'Gas', done: hasGas },
          { key: 'erc8004', label: 'ERC-8004', done: hasErc8004 },
          { key: 'sponsorship', label: 'Sponsorship', done: hasSponsorship }
        ];
        steps.forEach(function(s, i) {
          var bg = s.done ? 'var(--green-verify)' : 'var(--border-light)';
          var fg = s.done ? '#fff' : 'var(--text-muted)';
          html += '<span style="font-family:var(--font-mono);font-size:0.6rem;padding:2px 6px;background:' + bg + ';color:' + fg + ';font-weight:600;">' + s.label + '</span>';
          if (i < steps.length - 1) html += '<span style="color:var(--text-muted);font-size:0.6rem;">→</span>';
        });
        html += '</div>';

        if (hasWallet) {
          html += '<div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);margin-bottom:0.35rem;">Wallet: <a href="https://celoscan.io/address/' + esc(econ.wallet.address) + '" target="_blank" style="color:var(--accent);">' + truncAddr(econ.wallet.address) + '</a></div>';
        }
        if (hasErc8004) {
          html += '<div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);margin-bottom:0.35rem;">ERC-8004: Token #' + esc(econ.erc8004.tokenId || '?') + '</div>';
        }
        if (hasSponsorship) {
          html += '<div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);margin-bottom:0.35rem;">Pool: ' + esc(econ.sponsorship.tokenSymbol || '') + ' / SELFCLAW (' + esc(econ.sponsorship.status) + ')</div>';
        }

        html += '<div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.5rem;" id="mc-econ-' + esc(agent.id) + '">';
        if (!hasWallet) {
          html += '<button class="action-btn" style="font-size:0.65rem;padding:3px 8px;" onclick="mcSetupWallet(\'' + esc(agent.id) + '\')">Setup Wallet</button>';
        } else if (!hasGas) {
          html += '<button class="action-btn" style="font-size:0.65rem;padding:3px 8px;" onclick="mcRequestGas(\'' + esc(agent.id) + '\')">Request Gas</button>';
        }
        if (hasWallet && !hasErc8004) {
          html += '<button class="action-btn" style="font-size:0.65rem;padding:3px 8px;" onclick="mcRegisterErc8004(\'' + esc(agent.id) + '\')">Register Identity</button>';
        }
        html += '</div>';
        html += '</div>';

        if (recentTasks.length > 0) {
          html += '<div style="border-top:1px solid var(--border-light);padding-top:0.75rem;margin-top:0.5rem;">';
          html += '<div style="font-family:var(--font-mono);font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:0.5rem;">Recent Activity</div>';
          recentTasks.slice(0, 3).forEach(function(task) {
            var icon = task.status === 'completed' ? '&#10003;' : task.status === 'failed' ? '&#10007;' : '&#8226;';
            var iconColor = task.status === 'completed' ? 'var(--green-verify)' : task.status === 'failed' ? 'var(--red)' : 'var(--text-muted)';
            html += '<div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem;">';
            html += '<span style="color:' + iconColor + ';">' + icon + '</span> ';
            html += esc(task.skillId) + ' &mdash; ' + fmtDate(task.completedAt || task.createdAt);
            html += '</div>';
          });
          html += '</div>';
        }

        html += '<div style="margin-top:0.75rem;display:flex;gap:0.5rem;">';
        html += '<a href="/create-assistant?manage=' + encodeURIComponent(agent.id) + '" class="action-btn" style="font-size:0.7rem;">Manage Skills</a>';
        if (agent.status === 'active') {
          html += '<button class="action-btn" style="font-size:0.7rem;color:var(--red);border-color:var(--red);" onclick="toggleHostedAgent(\'' + esc(agent.id) + '\',\'paused\')">Pause</button>';
        } else {
          html += '<button class="action-btn" style="font-size:0.7rem;color:var(--green-verify);border-color:var(--green-verify);" onclick="toggleHostedAgent(\'' + esc(agent.id) + '\',\'active\')">Resume</button>';
        }
        html += '</div>';
        html += '</div>';
        return html;
      }).join('');
    }

    async function mcSetupWallet(id) {
      var btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Setting up...';
      try {
        var r = await fetch('/api/selfclaw/v1/miniclaws/' + encodeURIComponent(id) + '/setup-wallet', { method: 'POST', credentials: 'include' });
        var data = await r.json();
        if (!r.ok) { alert(data.error || 'Failed'); btn.disabled = false; btn.textContent = 'Setup Wallet'; return; }
        if (data.privateKey) {
          alert('WALLET CREATED\\n\\nAddress: ' + data.address + '\\n\\nPrivate Key: ' + data.privateKey + '\\n\\nSAVE THIS KEY NOW — it will NOT be shown again.');
        }
        window.location.reload();
      } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Setup Wallet';
      }
    }

    async function mcRequestGas(id) {
      var btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Requesting...';
      try {
        var r = await fetch('/api/selfclaw/v1/miniclaws/' + encodeURIComponent(id) + '/request-gas', { method: 'POST', credentials: 'include' });
        var data = await r.json();
        if (!r.ok) { alert(data.error || 'Failed'); btn.disabled = false; btn.textContent = 'Request Gas'; return; }
        alert('Gas received! TX: ' + (data.txHash || '').substring(0, 16) + '...');
        window.location.reload();
      } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Request Gas';
      }
    }

    async function mcRegisterErc8004(id) {
      var btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Preparing...';
      try {
        var r = await fetch('/api/selfclaw/v1/miniclaws/' + encodeURIComponent(id) + '/register-erc8004', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: '{}' });
        var data = await r.json();
        if (!r.ok) { alert(data.error || 'Failed'); btn.disabled = false; btn.textContent = 'Register Identity'; return; }
        var msg = 'ERC-8004 Registration Prepared\\n\\n';
        msg += 'Contract: ' + (data.unsignedTx.to || '') + '\\n';
        msg += 'Gas: ~' + (data.deployment ? data.deployment.estimatedCost : 'unknown') + '\\n\\n';
        msg += 'Sign the transaction with your miniclaw wallet to complete registration.\\n';
        msg += 'Then confirm with the txHash at:\\nPOST /api/selfclaw/v1/miniclaws/' + id + '/confirm-erc8004';
        alert(msg);
        btn.disabled = false;
        btn.textContent = 'Register Identity';
      } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Register Identity';
      }
    }

    async function toggleHostedAgent(id, newStatus) {
      try {
        var res = await fetch('/api/selfclaw/v1/hosted-agents/' + encodeURIComponent(id), {
          method: 'PATCH',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        if (res.ok) window.location.reload();
      } catch (err) {
        console.error('Failed to toggle agent:', err);
      }
    }

    document.getElementById('login-trigger').addEventListener('click', function() {
      if (window.selfclawAuth) window.selfclawAuth.openLogin();
    });

    window.selfclawAuth.onReady(function(user) {
      if (user) {
        loadDashboard(user);
      } else {
        showAuthGate();
      }
    });
  </script>
  <script src="/nav-toggle.js"></script>
</body>
</html>
