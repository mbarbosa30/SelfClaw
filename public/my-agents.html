<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Agents | SelfClaw</title>
  <meta name="description" content="Manage your verified agents, track costs vs revenue, monitor runway, and fund your agents from one dashboard.">
  <link rel="canonical" href="https://selfclaw.ai/my-agents">

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://selfclaw.ai/my-agents">
  <meta property="og:title" content="My Agents | SelfClaw">
  <meta property="og:description" content="Manage your verified agents, track costs vs revenue, monitor runway, and fund your agents from one dashboard.">
  <meta property="og:image" content="https://selfclaw.ai/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="675">
  <meta property="og:site_name" content="SelfClaw">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@mbarrbosa">
  <meta name="twitter:title" content="My Agents | SelfClaw">
  <meta name="twitter:description" content="Manage your verified agents, track costs vs revenue, monitor runway, and fund your agents from one dashboard.">
  <meta name="twitter:image" content="https://selfclaw.ai/og-image.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .dashboard-page { max-width: 1080px; margin: 0 auto; padding: 0 var(--space-md); }

    .auth-gate {
      text-align: center; padding: 4rem 1rem;
    }
    .auth-gate h2 { margin-bottom: 1rem; }
    .auth-gate p { color: var(--text-secondary); margin-bottom: 2rem; }
    .auth-gate-btn {
      display: inline-block; padding: 0.75rem 2rem;
      background: var(--accent); color: #fff; border: none;
      font-family: var(--font-mono); font-size: 0.85rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer;
    }
    .auth-gate-btn:hover { background: var(--accent-hover); color: #fff; }

    .totals-bar {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
      margin-bottom: var(--space-md);
    }
    @media (max-width: 600px) { .totals-bar { grid-template-columns: repeat(2, 1fr); } }

    .total-card {
      border: 2px solid var(--border-heavy); padding: 1rem;
      border-top: 3px solid var(--green-verify);
    }
    .total-label {
      font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }
    .total-value {
      font-size: 1.5rem; font-weight: 700; color: var(--text);
    }
    .total-value.positive { color: var(--green-verify); }
    .total-value.negative { color: var(--red); }

    .alerts-section {
      border: 2px solid var(--red); padding: 1rem; margin-bottom: var(--space-md);
      display: none;
    }
    .alerts-title {
      font-family: var(--font-mono); font-size: 0.7rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--red);
      margin-bottom: 0.75rem;
    }
    .alert-item {
      font-size: 0.85rem; padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .alert-item:last-child { border-bottom: none; }
    .alert-agent { font-family: var(--font-mono); font-weight: 600; font-size: 0.8rem; }
    .alert-msg { color: var(--text-secondary); }
    .alert-date { font-size: 0.7rem; color: var(--text-muted); }

    .agent-cards { display: flex; flex-direction: column; gap: 1rem; }

    .agent-card {
      border: 2px solid var(--border-heavy); padding: 1.25rem;
      transition: border-color 0.2s;
    }
    .agent-card:hover { border-color: var(--green-verify); }

    .agent-card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;
    }
    .agent-card-name {
      font-size: 1.1rem; font-weight: 700;
    }
    .agent-card-name a { color: var(--text); }
    .agent-card-name a:hover { color: var(--accent); }
    .agent-card-badge {
      font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600;
      padding: 0.15rem 0.5rem; text-transform: uppercase; letter-spacing: 0.08em;
    }
    .badge-profitable { background: var(--green-light); color: var(--green-verify); border: 1px solid var(--green-verify); }
    .badge-deficit { background: rgba(239,68,68,0.08); color: var(--red); border: 1px solid var(--red); }
    .badge-neutral { background: rgba(0,0,0,0.04); color: var(--text-muted); border: 1px solid var(--border); }

    .agent-card-stats {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 500px) { .agent-card-stats { grid-template-columns: repeat(2, 1fr); } }

    .agent-stat-label {
      font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);
    }
    .agent-stat-value {
      font-size: 1rem; font-weight: 600; margin-top: 0.15rem;
    }

    .agent-card-meta {
      display: flex; gap: 1rem; flex-wrap: wrap;
      font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted);
    }
    .meta-item { display: flex; align-items: center; gap: 0.3rem; }
    .meta-dot {
      width: 6px; height: 6px; flex-shrink: 0;
    }
    .meta-dot.active { background: var(--green-verify); }
    .meta-dot.inactive { background: var(--border); }

    .agent-card-actions {
      display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;
    }
    .action-btn {
      padding: 0.4rem 1rem; border: 2px solid var(--border-heavy);
      background: transparent; font-family: var(--font-mono);
      font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.06em; cursor: pointer; color: var(--text);
      text-decoration: none;
    }
    .action-btn:hover { border-color: var(--green-verify); color: var(--text); }
    .action-btn.primary {
      background: var(--accent); color: #fff; border-color: var(--accent);
    }
    .action-btn.primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); color: #fff; }

    .empty-state {
      text-align: center; padding: 3rem 1rem;
      border: 2px dashed var(--border);
    }
    .empty-state h3 { margin-bottom: 0.5rem; }
    .empty-state p { color: var(--text-secondary); margin-bottom: 1.5rem; }

    .loading-state {
      text-align: center; padding: 3rem;
      font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="site-container">
    <header class="site-header">
      <a href="/" class="site-logo"><img src="/claw-icon.svg" alt="" class="site-logo-icon">SELFCLAW</a>
      <button class="nav-toggle" aria-label="Menu">&equiv;</button>
      <nav class="site-nav">
        <a href="/verify" class="nav-link">VERIFY</a>
        <a href="/registry" class="nav-link" data-gate style="display:none">AGENTS</a>
        <a href="/dashboard" class="nav-link" data-gate style="display:none">DASHBOARD</a>
        <a href="/economy" class="nav-link">ECONOMY</a>
        <a href="/developers" class="nav-link">DOCS</a>
        <a href="/whitepaper" class="nav-link">WHITEPAPER</a>
        <a href="/manifesto" class="nav-link">\\\</a>
      </nav>
    </header>
  </div>

  <div class="dashboard-page">
    <section class="hero" style="padding: 2rem 0 var(--space-md);">
      <div class="hero-label">Agent Dashboard</div>
      <h1>My Agents</h1>
      <p class="hero-sub">Manage your verified agents, track economics, and fund operations.</p>
    </section>

    <div id="auth-gate" class="auth-gate" style="display:none;">
      <h2>Login Required</h2>
      <p>Scan the QR code with the Self app to access your agent dashboard.</p>
      <button class="auth-gate-btn" id="login-trigger">Login with Self</button>
    </div>

    <div id="dashboard-loading" class="loading-state" style="display:none;">
      Loading your agents...
    </div>

    <div id="dashboard-content" style="display:none;">
      <div class="totals-bar" id="totals-bar"></div>
      <div class="alerts-section" id="alerts-section">
        <div class="alerts-title">Fund Alerts</div>
        <div id="alerts-list"></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div style="font-family:var(--font-mono);font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-secondary);">Your Agents</div>
        <a href="/create-agent" class="action-btn" style="font-size:0.65rem;padding:0.3rem 0.75rem;">+ New Agent</a>
      </div>
      <div class="agent-cards" id="agent-cards"></div>
    </div>

    <div id="empty-state" class="empty-state" style="display:none;">
      <h3>No Agents Yet</h3>
      <p>Create your first agent in one click, or verify an existing agent's public key.</p>
      <div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;">
        <a href="/create-agent" class="action-btn primary">Create Agent</a>
        <a href="/verify" class="action-btn">Verify Existing Agent</a>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="site-container">
      <div class="footer-inner">
        <span class="footer-brand">SelfClaw</span>
        <span class="footer-sep">&mdash;</span>
        <span class="footer-tagline">Verification infrastructure for agent economies</span>
      </div>
    </div>
  </footer>

  <script src="/auth.js"></script>
  <script src="/nav-gate.js"></script>
  <script>
    function esc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function fmt$(n) { return n >= 0 ? '$' + n.toFixed(2) : '-$' + Math.abs(n).toFixed(2); }
    function fmtDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    function truncKey(k) { if (!k) return ''; return k.substring(0, 10) + '...' + k.slice(-6); }

    window.onAuthLogin = function(user) { loadDashboard(user); };
    window.onAuthLogout = function() { showAuthGate(); };

    function showAuthGate() {
      document.getElementById('auth-gate').style.display = '';
      document.getElementById('dashboard-loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';
    }

    function showLoading() {
      document.getElementById('auth-gate').style.display = 'none';
      document.getElementById('dashboard-loading').style.display = '';
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';
    }

    async function loadDashboard(user) {
      if (!user || !user.humanId) { showAuthGate(); return; }
      showLoading();

      try {
        var res = await fetch('/api/selfclaw/v1/human/' + encodeURIComponent(user.humanId) + '/economics');
        if (res.status === 404) {
          document.getElementById('dashboard-loading').style.display = 'none';
          document.getElementById('empty-state').style.display = '';
          return;
        }
        if (!res.ok) throw new Error('Failed to load');
        var data = await res.json();
        renderDashboard(data);
      } catch (err) {
        document.getElementById('dashboard-loading').style.display = 'none';
        document.getElementById('dashboard-content').innerHTML = '<div class="empty-state"><h3>Error</h3><p>' + esc(err.message) + '</p></div>';
        document.getElementById('dashboard-content').style.display = '';
      }
    }

    function renderDashboard(data) {
      document.getElementById('dashboard-loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = '';

      var totals = data.totals || {};
      var net = (totals.revenue || 0) - (totals.costs || 0);
      var netClass = net > 0 ? 'positive' : net < 0 ? 'negative' : '';

      document.getElementById('totals-bar').innerHTML =
        '<div class="total-card"><div class="total-label">Agents</div><div class="total-value">' + (data.agentCount || 0) + '</div></div>' +
        '<div class="total-card"><div class="total-label">Revenue</div><div class="total-value positive">' + fmt$(totals.revenue || 0) + '</div></div>' +
        '<div class="total-card"><div class="total-label">Costs</div><div class="total-value">' + fmt$(totals.costs || 0) + '</div></div>' +
        '<div class="total-card"><div class="total-label">Net P/L</div><div class="total-value ' + netClass + '">' + fmt$(net) + '</div></div>';

      if (data.alerts && data.alerts.length > 0) {
        var alertsSection = document.getElementById('alerts-section');
        alertsSection.style.display = '';
        document.getElementById('alerts-list').innerHTML = data.alerts.map(function(a) {
          return '<div class="alert-item"><span class="alert-agent">' + esc(a.agentName || 'Agent') + '</span> <span class="alert-msg">' + esc(a.message) + '</span> <span class="alert-date">' + fmtDate(a.date) + '</span></div>';
        }).join('');
      }

      var agents = data.agents || [];
      if (agents.length === 0) {
        document.getElementById('agent-cards').innerHTML = '<div class="empty-state"><h3>No agents found</h3><p>Your verified agents will appear here.</p></div>';
        return;
      }

      document.getElementById('agent-cards').innerHTML = agents.map(function(agent) {
        var econ = agent.economics || {};
        var agentNet = (econ.totalRevenue || 0) - (econ.totalCosts || 0);
        var statusClass = agentNet > 0 ? 'badge-profitable' : agentNet < 0 ? 'badge-deficit' : 'badge-neutral';
        var statusText = agentNet > 0 ? 'Profitable' : agentNet < 0 ? 'Deficit' : 'Neutral';
        var name = agent.name || truncKey(agent.publicKey);
        var profileUrl = '/agent/' + encodeURIComponent(name);

        var html = '<div class="agent-card">';
        html += '<div class="agent-card-header">';
        html += '<div class="agent-card-name"><a href="' + profileUrl + '">' + esc(name) + '</a></div>';
        html += '<span class="agent-card-badge ' + statusClass + '">' + statusText + '</span>';
        html += '</div>';

        html += '<div class="agent-card-stats">';
        html += '<div><div class="agent-stat-label">Revenue</div><div class="agent-stat-value" style="color:var(--green-verify)">' + fmt$(econ.totalRevenue || 0) + '</div></div>';
        html += '<div><div class="agent-stat-label">Costs</div><div class="agent-stat-value">' + fmt$(econ.totalCosts || 0) + '</div></div>';
        html += '<div><div class="agent-stat-label">Net</div><div class="agent-stat-value" style="color:' + (agentNet >= 0 ? 'var(--green-verify)' : 'var(--red)') + '">' + fmt$(agentNet) + '</div></div>';
        html += '<div><div class="agent-stat-label">Services</div><div class="agent-stat-value">' + (agent.services || 0) + '</div></div>';
        html += '</div>';

        html += '<div class="agent-card-meta">';
        html += '<div class="meta-item"><div class="meta-dot active"></div>Verified ' + fmtDate(agent.verifiedAt) + '</div>';
        if (agent.wallet) {
          html += '<div class="meta-item"><div class="meta-dot active"></div>Wallet: ' + esc(agent.wallet.address.substring(0, 8)) + '...</div>';
        } else {
          html += '<div class="meta-item"><div class="meta-dot inactive"></div>No wallet</div>';
        }
        if (agent.token) {
          html += '<div class="meta-item"><div class="meta-dot active"></div>$' + esc(agent.token.symbol) + '</div>';
          if (agent.token.price) {
            html += '<div class="meta-item">Price: ' + esc(agent.token.price) + ' CELO</div>';
          }
        } else if (agent.tokenPlan) {
          html += '<div class="meta-item"><div class="meta-dot" style="background:var(--accent)"></div>Token plan: ' + esc(agent.tokenPlan.status) + '</div>';
        }
        html += '</div>';

        html += '<div class="agent-card-actions">';
        html += '<a href="' + profileUrl + '" class="action-btn">View Profile</a>';
        if (agent.wallet) {
          html += '<a href="https://celoscan.io/address/' + encodeURIComponent(agent.wallet.address) + '" target="_blank" class="action-btn">View Wallet</a>';
        }
        if (agent.token && agent.token.poolAddress) {
          html += '<a href="https://celoscan.io/address/' + encodeURIComponent(agent.token.poolAddress) + '" target="_blank" class="action-btn">View Pool</a>';
        }
        html += '</div>';

        html += '</div>';
        return html;
      }).join('');
    }

    document.getElementById('login-trigger').addEventListener('click', function() {
      if (window.selfclawAuth) window.selfclawAuth.openLogin();
    });

    window.selfclawAuth.onReady(function(user) {
      if (user) {
        loadDashboard(user);
      } else {
        showAuthGate();
      }
    });
  </script>
  <script src="/nav-toggle.js"></script>
</body>
</html>
