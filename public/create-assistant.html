<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Create Miniclaw | SelfClaw</title>
  <meta name="description" content="Create a lightweight AI miniclaw that runs on SelfClaw's infrastructure. No coding required.">
  <link rel="canonical" href="https://selfclaw.ai/create-assistant">

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://selfclaw.ai/create-assistant">
  <meta property="og:title" content="Create Miniclaw | SelfClaw">
  <meta property="og:description" content="Create a lightweight AI miniclaw that runs on SelfClaw's infrastructure. No coding required.">
  <meta property="og:image" content="https://selfclaw.ai/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="675">
  <meta property="og:site_name" content="SelfClaw">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@mbarrbosa">
  <meta name="twitter:title" content="Create Miniclaw | SelfClaw">
  <meta name="twitter:description" content="Create a lightweight AI miniclaw that runs on SelfClaw's infrastructure. No coding required.">
  <meta name="twitter:image" content="https://selfclaw.ai/og-image.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .create-page { max-width: 800px; margin: 0 auto; padding: 0 var(--space-md); width: 100%; overflow-x: hidden; }

    .miniapp-bar {
      display: none;
      align-items: center; gap: 0.5rem;
      padding: 0.6rem 1rem;
      border-bottom: 2px solid var(--border-heavy);
      font-family: var(--font-mono); font-size: 0.75rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
    }
    .miniapp-bar img { width: 18px; height: 18px; }
    .miniapp-bar a { color: var(--text); text-decoration: none; }

    .wizard-steps {
      display: flex; gap: 0; margin-bottom: var(--space-md);
      border: 2px solid var(--border-heavy);
    }
    .wizard-step {
      flex: 1; padding: 0.6rem 0.4rem; text-align: center;
      font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      color: var(--text-muted); background: var(--bg-card);
      border-right: 2px solid var(--border-heavy);
      transition: all 0.2s;
    }
    .wizard-step:last-child { border-right: none; }
    .wizard-step.active { background: var(--text); color: var(--bg); }
    .wizard-step.done { background: var(--green-verify); color: #fff; }
    .wizard-step-num {
      display: inline-block; width: 18px; height: 18px; line-height: 18px;
      text-align: center; border: 2px solid currentColor; margin-right: 0.2rem;
      font-size: 0.55rem;
    }

    .wizard-panel { display: none; }
    .wizard-panel.active { display: block; }

    .assistant-form .form-group { margin-bottom: 1rem; }
    .assistant-form label {
      display: block; font-family: var(--font-mono); font-size: 0.7rem;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em;
      margin-bottom: 0.3rem; color: var(--text);
    }
    .assistant-form .input {
      width: 100%; max-width: 100%; padding: 0.55rem 0.75rem;
      border: 2px solid var(--border-heavy); background: var(--bg-card);
      font-family: var(--font-mono); font-size: 0.85rem; color: var(--text);
      box-sizing: border-box;
    }
    .assistant-form .input:focus { outline: none; border-color: var(--green-verify); }
    .assistant-form .input::placeholder { color: var(--text-muted); }
    .assistant-form textarea.input { min-height: 60px; resize: vertical; font-family: var(--font-sans); overflow-wrap: break-word; word-break: break-word; }

    .emoji-grid {
      display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.4rem;
    }
    .emoji-option {
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; padding: 0.45rem; border: 2px solid var(--border);
      background: var(--bg-card); cursor: pointer; transition: border-color 0.2s;
    }
    .emoji-option:hover { border-color: var(--border-heavy); }
    .emoji-option.selected { border-color: var(--green-verify); background: rgba(34,197,94,0.05); }

    .next-btn, .create-btn {
      width: 100%; padding: 0.75rem; border: none;
      font-family: var(--font-mono); font-size: 0.85rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
      cursor: pointer; transition: background 0.2s;
    }
    .next-btn { background: var(--accent); color: #fff; }
    .next-btn:hover { background: var(--accent-hover); }
    .next-btn:disabled, .create-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .create-btn { background: var(--green-verify); color: #fff; }
    .create-btn:hover { background: #1aab4d; }

    .skills-heading {
      font-family: var(--font-mono); font-size: 0.75rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
      margin-bottom: 0.75rem; color: var(--text);
    }
    .skills-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.6rem;
      margin-bottom: 1rem;
    }
    .skill-card {
      border: 2px solid var(--border); padding: 0.75rem;
      background: var(--bg-card); transition: border-color 0.2s; cursor: pointer;
    }
    .skill-card.enabled { border-color: var(--green-verify); }
    .skill-card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 0.35rem;
    }
    .skill-card-name {
      font-family: var(--font-mono); font-size: 0.7rem; font-weight: 600;
      display: flex; align-items: center; gap: 0.3rem;
    }
    .skill-card-icon { font-size: 0.9rem; }
    .skill-card-desc {
      font-size: 0.75rem; color: var(--text-secondary); line-height: 1.3;
    }
    .skill-toggle {
      position: relative; width: 32px; height: 18px;
      background: var(--border); cursor: pointer;
      flex-shrink: 0;
    }
    .skill-toggle.on { background: var(--green-verify); }
    .skill-toggle-knob {
      position: absolute; top: 2px; left: 2px;
      width: 14px; height: 14px; background: #fff;
      transition: left 0.2s;
    }
    .skill-toggle.on .skill-toggle-knob { left: 16px; }
    .skills-note {
      font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted);
      margin-bottom: 1rem;
    }
    .skills-loading {
      text-align: center; padding: 1.5rem;
      font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted);
    }

    .success-card {
      border: 2px solid var(--green-verify); padding: 1.25rem;
      margin-bottom: 1rem; text-align: center;
    }
    .success-emoji { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .success-title {
      font-family: var(--font-mono); font-size: 0.8rem; font-weight: 600;
      color: var(--green-verify); text-transform: uppercase; letter-spacing: 0.1em;
      margin-bottom: 0.5rem;
    }
    .success-name {
      font-size: 1.1rem; font-weight: 600; color: var(--text);
    }
    .success-detail {
      font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;
    }

    .goto-btn {
      display: block; width: 100%; padding: 0.75rem; border: 2px solid var(--border-heavy);
      background: var(--text); color: var(--bg);
      font-family: var(--font-mono); font-size: 0.85rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
      cursor: pointer; text-align: center; text-decoration: none;
      transition: all 0.2s; margin-bottom: 0.75rem;
    }
    .goto-btn:hover { background: var(--accent); border-color: var(--accent); color: #fff; }

    .login-gate {
      text-align: center; padding: 2rem 1rem;
      border: 2px solid var(--border-heavy);
    }
    .login-gate-title {
      font-family: var(--font-mono); font-size: 0.8rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em;
      margin-bottom: 0.75rem;
    }
    .login-gate-desc {
      font-size: 0.85rem; color: var(--text-secondary);
      margin-bottom: 1.25rem; max-width: 400px; margin-left: auto; margin-right: auto;
    }
    .login-gate-btn {
      padding: 0.65rem 2rem; border: 2px solid var(--border-heavy);
      background: var(--bg-card); color: var(--text);
      font-family: var(--font-mono); font-size: 0.8rem; font-weight: 600;
      cursor: pointer; transition: border-color 0.2s;
    }
    .login-gate-btn:hover { border-color: var(--green-verify); }

    .error-msg {
      border: 2px solid var(--red); padding: 0.6rem 0.75rem;
      font-family: var(--font-mono); font-size: 0.75rem; color: var(--red);
      margin-bottom: 0.75rem; display: none;
    }

    .section-label {
      font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    body.miniapp-mode .site-container { display: none; }
    body.miniapp-mode .site-footer { display: none; }
    body.miniapp-mode .miniapp-bar { display: flex; }
    body.miniapp-mode .create-page { max-width: 100%; padding: 0 0.75rem; }
    body.miniapp-mode .hero { padding: 1rem 0 0.75rem !important; }
    body.miniapp-mode .hero h1 { font-size: 1.3rem; margin-bottom: 0; }
    body.miniapp-mode .hero-sub, body.miniapp-mode .hero-label { display: none; }

    @media (max-width: 768px) {
      .skills-grid { grid-template-columns: 1fr; }
      .emoji-grid { grid-template-columns: repeat(6, 1fr); }
      .create-page { padding: 0 0.75rem; }
      .hero h1 { font-size: 1.4rem; }
      .wizard-steps { flex-wrap: nowrap; }
      .wizard-step { font-size: 0.55rem; padding: 0.5rem 0.3rem; }
    }
    @media (max-width: 400px) {
      .emoji-grid { grid-template-columns: repeat(6, 1fr); gap: 0.3rem; }
      .emoji-option { padding: 0.35rem; font-size: 1.15rem; }
    }
  </style>
</head>
<body>
  <div class="miniapp-bar">
    <a href="/"><img src="/claw-icon.svg" alt="">SELFCLAW</a>
  </div>

  <div class="site-container">
    <header class="site-header">
      <a href="/" class="site-logo"><img src="/claw-icon.svg" alt="" class="site-logo-icon">SELFCLAW</a>
      <button class="nav-toggle" aria-label="Menu">&equiv;</button>
      <nav class="site-nav">
        <a href="/verify" class="nav-link">VERIFY</a>
        <a href="/registry" class="nav-link" data-gate style="display:none">AGENTS</a>
        <a href="/dashboard" class="nav-link" data-gate style="display:none">DASHBOARD</a>
        <a href="/economy" class="nav-link">ECONOMY</a>
        <a href="/developers" class="nav-link">DOCS</a>
        <a href="/guide" class="nav-link">GUIDE</a>
        <a href="/whitepaper" class="nav-link">WHITEPAPER</a>
        <a href="/manifesto" class="nav-link">\\\</a>
      </nav>
    </header>
  </div>

  <div class="create-page">
    <section class="hero" style="padding: 2rem 0 var(--space-md);">
      <div class="hero-label">Miniclaw</div>
      <h1>Create your Miniclaw</h1>
      <p class="hero-sub">Name it, personalize it, choose skills, done.</p>
    </section>

    <div id="login-gate" class="login-gate" style="display:none;">
      <div class="login-gate-title">Connect to continue</div>
      <div class="login-gate-desc">Your miniclaw will be linked to your wallet.</div>
      <div style="display:flex;flex-direction:column;gap:0.75rem;align-items:center;">
        <button class="login-gate-btn" onclick="window.selfclawAuth && window.selfclawAuth.openLogin()" style="width:100%;max-width:300px;">
          <span id="login-btn-text">Connect Wallet</span>
        </button>
        <div id="passport-alt" style="font-family:var(--font-mono);font-size:0.6rem;color:var(--text-muted);display:none;">or <a href="#" onclick="window.selfclawAuth && window.selfclawAuth.openLogin(); return false;" style="color:var(--accent);">use Self.xyz passport</a></div>
      </div>
    </div>

    <div id="wizard-container" style="display:none;">
      <div class="wizard-steps">
        <div class="wizard-step active" id="ws-1"><span class="wizard-step-num">1</span>Setup</div>
        <div class="wizard-step" id="ws-2"><span class="wizard-step-num">2</span>Skills</div>
        <div class="wizard-step" id="ws-3"><span class="wizard-step-num">3</span>Done</div>
      </div>

      <div class="wizard-panel active" id="panel-setup">
        <div class="assistant-form">
          <div class="form-group">
            <label for="assistant-name">Name</label>
            <input type="text" id="assistant-name" class="input" placeholder="my-miniclaw" maxlength="24">
          </div>

          <div class="form-group">
            <label>Icon</label>
            <div class="emoji-grid" id="emoji-grid"></div>
          </div>

          <div class="form-group">
            <label for="assistant-desc">Focus <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text-muted);">(optional)</span></label>
            <textarea id="assistant-desc" class="input" placeholder="What should your miniclaw focus on?" style="min-height:50px;"></textarea>
          </div>

          <div id="interests-section" style="display:none;">
            <div class="section-label">Personalization (optional)</div>

            <div class="form-group">
              <label for="interests-input">Interests</label>
              <input type="text" id="interests-input" class="input" placeholder="DeFi, AI agents, Celo, NFTs...">
            </div>

            <div class="form-group">
              <label for="topics-input">Topics to Watch</label>
              <input type="text" id="topics-input" class="input" placeholder="Uniswap V4, Self.xyz...">
            </div>

            <div class="form-group">
              <label for="context-input">Context <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text-muted);">(your goals)</span></label>
              <textarea id="context-input" class="input" placeholder="I'm building an agent swarm for DeFi..." maxlength="500" style="min-height:50px;"></textarea>
            </div>

            <div class="form-group">
              <label>Socials</label>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;width:100%;">
                <input type="text" id="social-twitter" class="input" placeholder="@X handle">
                <input type="text" id="social-telegram" class="input" placeholder="@Telegram">
              </div>
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
            <button type="button" id="toggle-interests-btn" onclick="toggleInterests()" style="background:none;border:2px solid var(--accent);font-family:var(--font-mono);font-size:0.7rem;font-weight:600;color:var(--accent);cursor:pointer;padding:0.45rem 0.85rem;text-transform:uppercase;letter-spacing:0.06em;transition:all 0.2s;">+ Add interests &amp; socials</button>
          </div>

          <div class="error-msg" id="identity-error"></div>

          <button class="next-btn" id="next-btn" onclick="goToSkills()">Next</button>
        </div>
      </div>

      <div class="wizard-panel" id="panel-skills">
        <div class="skills-heading">Skills</div>
        <div id="skills-container">
          <div class="skills-loading">Loading skills...</div>
        </div>
        <div class="skills-note">Defaults are pre-selected. Customize anytime from your dashboard.</div>
        <div class="error-msg" id="skills-error"></div>
        <div style="display:flex;gap:0.5rem;">
          <button class="next-btn" style="background:var(--bg-card);color:var(--text);border:2px solid var(--border-heavy);flex:0 0 auto;width:auto;padding:0.75rem 1.25rem;" onclick="setStep(1)">Back</button>
          <button class="create-btn" id="create-assistant-btn" onclick="createAssistant()">Create Miniclaw</button>
        </div>
      </div>

      <div class="wizard-panel" id="panel-done">
        <div class="success-card">
          <div class="success-emoji" id="done-emoji"></div>
          <div class="success-title">Miniclaw Created</div>
          <div class="success-name" id="done-name"></div>
          <div class="success-detail">Running on SelfClaw infrastructure 24/7. Your AI assistant is ready to chat.</div>
        </div>

        <a href="/my-agents" class="goto-btn" id="goto-dashboard-btn">Go to Dashboard</a>

        <a href="/create-assistant" class="goto-btn" style="background:var(--bg-card);color:var(--text);">Create Another</a>
      </div>
    </div>

    <footer class="site-footer">
      <nav class="footer-nav">
        <a href="/">Home</a>
        <a href="/verify">Verify</a>
        <a href="/registry" data-gate-footer style="display:none">Agents</a>
        <a href="/dashboard" data-gate-footer style="display:none">Dashboard</a>
        <a href="/economy">Economy</a>
        <a href="/developers">Docs</a>
        <a href="/whitepaper">Whitepaper</a>
      </nav>
      <div class="footer-meta">
        <span>Powered by <a href="https://self.xyz" target="_blank">Self.xyz</a> zero-knowledge proofs</span>
        <span>Built by <a href="https://zeno.vision" target="_blank" rel="noopener">Zeno</a> &middot; <a href="https://github.com/mbarbosa30/SelfClaw" target="_blank" rel="noopener">GitHub</a> &middot; <a href="https://t.me/+GC2quXBnarw1MzU0" target="_blank" rel="noopener">Telegram</a> &middot; <a href="https://x.com/selfclaw" target="_blank" rel="noopener">X</a></span>
      </div>
    </footer>
  </div>

  <script src="/auth.js"></script>
  <script src="/nav-gate.js"></script>
  <script src="/nav-toggle.js"></script>
  <script>
    var selectedEmoji = '';
    var skillsData = [];
    var enabledSkills = {};
    var createdAgent = null;
    var isMiniPayEnv = false;

    var EMOJIS = ['\u{1F916}', '\u{1F9E0}', '\u{1F4A1}', '\u{1F50D}', '\u{1F4CA}', '\u{1F6E1}\uFE0F', '\u{1F680}', '\u{1F3AF}', '\u{1F4B0}', '\u26A1', '\u{1F310}', '\u{1F91D}'];

    function esc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    function detectMiniPay() {
      if (window.ethereum && (window.ethereum.isMiniPay || window.ethereum.isMinipay)) return true;
      if (navigator.userAgent && navigator.userAgent.indexOf('MiniPay') !== -1) return true;
      return false;
    }

    function initEmojis() {
      var grid = document.getElementById('emoji-grid');
      var html = '';
      for (var i = 0; i < EMOJIS.length; i++) {
        html += '<div class="emoji-option" data-emoji="' + EMOJIS[i] + '" onclick="selectEmoji(this)">' + EMOJIS[i] + '</div>';
      }
      grid.innerHTML = html;
      var first = grid.querySelector('.emoji-option');
      if (first) { first.classList.add('selected'); selectedEmoji = first.getAttribute('data-emoji'); }
    }

    function selectEmoji(el) {
      var all = document.querySelectorAll('.emoji-option');
      for (var i = 0; i < all.length; i++) all[i].classList.remove('selected');
      el.classList.add('selected');
      selectedEmoji = el.getAttribute('data-emoji');
    }

    function toggleInterests() {
      var section = document.getElementById('interests-section');
      var btn = document.getElementById('toggle-interests-btn');
      if (section.style.display === 'none') {
        section.style.display = '';
        btn.textContent = '- Hide interests & socials';
      } else {
        section.style.display = 'none';
        btn.textContent = '+ Add interests & socials';
      }
    }

    function goToSkills() {
      var name = document.getElementById('assistant-name').value.trim();
      var errEl = document.getElementById('identity-error');
      if (!name) {
        errEl.textContent = 'Please enter a name.';
        errEl.style.display = '';
        return;
      }
      if (name.length > 24) {
        errEl.textContent = 'Name must be 24 characters or less.';
        errEl.style.display = '';
        return;
      }
      errEl.style.display = 'none';
      setStep(2);
      loadSkills();
    }

    function setStep(step) {
      var panels = ['panel-setup', 'panel-skills', 'panel-done'];
      var steps = ['ws-1', 'ws-2', 'ws-3'];
      for (var i = 0; i < panels.length; i++) {
        document.getElementById(panels[i]).classList.remove('active');
        document.getElementById(steps[i]).classList.remove('active', 'done');
      }
      for (var i = 0; i < step - 1; i++) {
        document.getElementById(steps[i]).classList.add('done');
      }
      document.getElementById(steps[step - 1]).classList.add('active');
      document.getElementById(panels[step - 1]).classList.add('active');
    }

    async function loadSkills() {
      var container = document.getElementById('skills-container');
      try {
        var res = await fetch('/api/selfclaw/v1/hosted-agents/skills');
        if (!res.ok) throw new Error('Failed to load skills');
        var data = await res.json();
        skillsData = data.skills || data;
        if (!Array.isArray(skillsData)) skillsData = [];
        renderSkills();
      } catch (err) {
        container.innerHTML = '<div class="skills-loading">Could not load skills. You can add them later from your dashboard.</div>';
      }
    }

    function renderSkills() {
      var container = document.getElementById('skills-container');
      if (!skillsData || !skillsData.length) {
        container.innerHTML = '<div class="skills-loading">No skills found. You can add them later from your dashboard.</div>';
        return;
      }
      var html = '<div class="skills-grid">';
      for (var i = 0; i < skillsData.length; i++) {
        var skill = skillsData[i];
        var id = skill.id || skill.slug || skill.name;
        var isDefault = (id === 'wallet-monitor' || id === 'economics-tracker');
        if (isDefault) enabledSkills[id] = true;
        var enabledClass = (isDefault || enabledSkills[id]) ? ' enabled' : '';
        var toggleClass = (isDefault || enabledSkills[id]) ? ' on' : '';
        html += '<div class="skill-card' + enabledClass + '" id="skill-card-' + esc(id) + '" onclick="toggleSkill(\'' + esc(id) + '\')">';
        html += '<div class="skill-card-header">';
        html += '<div class="skill-card-name"><span class="skill-card-icon">' + esc(skill.icon || '') + '</span> ' + esc(skill.name || id) + '</div>';
        html += '<div class="skill-toggle' + toggleClass + '" id="toggle-' + esc(id) + '">';
        html += '<div class="skill-toggle-knob"></div>';
        html += '</div>';
        html += '</div>';
        html += '<div class="skill-card-desc">' + esc(skill.description || '') + '</div>';
        html += '</div>';
      }
      html += '</div>';
      container.innerHTML = html;
    }

    function toggleSkill(id) {
      enabledSkills[id] = !enabledSkills[id];
      var toggle = document.getElementById('toggle-' + id);
      var card = document.getElementById('skill-card-' + id);
      if (enabledSkills[id]) {
        toggle.classList.add('on');
        card.classList.add('enabled');
      } else {
        toggle.classList.remove('on');
        card.classList.remove('enabled');
      }
    }

    async function createAssistant() {
      var btn = document.getElementById('create-assistant-btn');
      var errEl = document.getElementById('skills-error');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      errEl.style.display = 'none';

      var name = document.getElementById('assistant-name').value.trim();
      var desc = document.getElementById('assistant-desc').value.trim();
      var skills = [];
      for (var key in enabledSkills) {
        if (enabledSkills[key]) skills.push(key);
      }

      var interestsRaw = document.getElementById('interests-input').value.trim();
      var topicsRaw = document.getElementById('topics-input').value.trim();
      var contextVal = document.getElementById('context-input').value.trim();
      var twitterVal = document.getElementById('social-twitter').value.trim().replace(/^@/, '');
      var telegramVal = document.getElementById('social-telegram').value.trim().replace(/^@/, '');

      var interestsArr = interestsRaw ? interestsRaw.split(',').map(function(s) { return s.trim(); }).filter(Boolean) : [];
      var topicsArr = topicsRaw ? topicsRaw.split(',').map(function(s) { return s.trim(); }).filter(Boolean) : [];
      var socialObj = {};
      if (twitterVal) socialObj.twitter = twitterVal;
      if (telegramVal) socialObj.telegram = telegramVal;

      try {
        var res = await fetch('/api/selfclaw/v1/hosted-agents', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            emoji: selectedEmoji,
            description: desc,
            enabledSkills: skills,
            interests: interestsArr,
            topicsToWatch: topicsArr,
            personalContext: contextVal || null,
            socialHandles: socialObj
          })
        });
        if (!res.ok) {
          var err = await res.json().catch(function() { return {}; });
          throw new Error(err.error || err.message || 'Failed to create miniclaw');
        }
        createdAgent = await res.json();
        showDone();
      } catch (err) {
        errEl.textContent = err.message;
        errEl.style.display = '';
        btn.disabled = false;
        btn.textContent = 'Create Miniclaw';
      }
    }

    function showDone() {
      setStep(3);
      var agentData = createdAgent.agent || createdAgent;
      document.getElementById('done-name').textContent = agentData.name || '';
      document.getElementById('done-emoji').textContent = agentData.emoji || selectedEmoji || '';
    }

    window.onAuthLogin = function(user) {
      document.getElementById('login-gate').style.display = 'none';
      document.getElementById('wizard-container').style.display = '';
    };

    window.onAuthLogout = function() {
      document.getElementById('login-gate').style.display = '';
      document.getElementById('wizard-container').style.display = 'none';
    };

    function initPage() {
      initEmojis();

      isMiniPayEnv = detectMiniPay();
      if (isMiniPayEnv) {
        document.body.classList.add('miniapp-mode');
        document.getElementById('login-btn-text').textContent = 'Connect MiniPay';
        var dashBtn = document.getElementById('goto-dashboard-btn');
        if (dashBtn) dashBtn.href = '/miniapp';
      } else {
        document.getElementById('passport-alt').style.display = '';
      }

      if (!isMiniPayEnv) {
        setTimeout(function() {
          if (detectMiniPay()) {
            isMiniPayEnv = true;
            document.body.classList.add('miniapp-mode');
            document.getElementById('login-btn-text').textContent = 'Connect MiniPay';
            document.getElementById('passport-alt').style.display = 'none';
            var dashBtn = document.getElementById('goto-dashboard-btn');
            if (dashBtn) dashBtn.href = '/miniapp';
          }
        }, 500);
      }

      if (window.selfclawAuth) {
        window.selfclawAuth.onReady(function(user) {
          if (user) {
            document.getElementById('login-gate').style.display = 'none';
            document.getElementById('wizard-container').style.display = '';
          } else {
            document.getElementById('login-gate').style.display = '';
            document.getElementById('wizard-container').style.display = 'none';
          }
        });
      } else {
        fetch('/api/auth/status').then(function(r) { return r.json(); }).then(function(data) {
          if (data && data.loggedIn) {
            document.getElementById('login-gate').style.display = 'none';
            document.getElementById('wizard-container').style.display = '';
          } else {
            document.getElementById('login-gate').style.display = '';
          }
        }).catch(function() {
          document.getElementById('login-gate').style.display = '';
        });
      }
    }

    initPage();
  </script>
</body>
</html>
