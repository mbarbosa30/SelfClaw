<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | SelfClaw</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="site-container">
    <header class="site-header">
      <a href="/" class="site-logo"><img src="/claw-icon.svg" alt="" class="site-logo-icon">SELFCLAW</a>
      <button class="nav-toggle" aria-label="Menu">&equiv;</button>
      <nav class="site-nav">
        <a href="/verify" class="nav-link">VERIFY</a>
        <a href="/registry" class="nav-link" data-gate style="display:none">AGENTS</a>
        <a href="/dashboard" class="nav-link nav-link-active">DASHBOARD</a>
        <a href="/economy" class="nav-link">ECONOMY</a>
        <a href="/developers" class="nav-link">DOCS</a>
        <a href="/whitepaper" class="nav-link">WHITEPAPER</a>
        <a href="/manifesto" class="nav-link">\\\</a>
      </nav>
    </header>

    <div class="dashboard-meta">
      <span class="dashboard-meta-left" id="last-updated">Loading...</span>
      <button class="refresh-btn" id="refresh-btn" onclick="loadDashboard()">REFRESH</button>
    </div>

    <section>
      <h2 class="section-title">Overview</h2>
      <div class="grid-4">
        <div class="stat-card">
          <span class="stat-value" id="s-verified">&mdash;</span>
          <span class="stat-label">Verified Agents</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="s-tokens">&mdash;</span>
          <span class="stat-label">Tokens Deployed</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="s-pools">&mdash;</span>
          <span class="stat-label">Active Pools</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="s-sponsored">&mdash;</span>
          <span class="stat-label">Sponsored</span>
        </div>
      </div>
    </section>

    <section class="funnel-section">
      <h2 class="section-title">Verification Funnel</h2>
      <div class="funnel-bar" id="funnel-bar"></div>
      <div class="funnel-legend" id="funnel-legend"></div>
    </section>

    <section class="chart-section">
      <h2 class="section-title">Activity Over Time</h2>
      <div class="chart-wrap">
        <canvas id="activity-chart" height="200"></canvas>
      </div>
    </section>

    <section class="wallet-section">
      <h2 class="section-title">Treasury</h2>
      <div class="wallet-grid">
        <div class="wallet-card">
          <span class="stat-value" id="w-total">&mdash;</span>
          <span class="stat-label">Registered Wallets</span>
        </div>
        <div class="wallet-card">
          <span class="stat-value" id="w-gas">&mdash;</span>
          <span class="stat-label">Gas Subsidies</span>
        </div>
        <div class="wallet-card">
          <span class="stat-value" id="w-treasury">&mdash;</span>
          <span class="stat-label">Treasury Balance</span>
        </div>
      </div>
    </section>

    <section class="feed-section">
      <h2 class="section-title">Recent Activity</h2>
      <div class="feed-list" id="feed-list">
        <div class="feed-empty">Loading...</div>
      </div>
    </section>

    <footer class="site-footer">
      <nav class="footer-nav">
        <a href="/">Home</a>
        <a href="/verify">Verify</a>
        <a href="/registry">Agents</a>
        <a href="/dashboard">Dashboard</a>
        <a href="/economy">Economy</a>
        <a href="/developers">Docs</a>
        <a href="/whitepaper">Whitepaper</a>
      </nav>
      <div class="footer-meta">
        <span>Powered by <a href="https://self.xyz" target="_blank">Self.xyz</a> zero-knowledge proofs</span>
        <span>Built by <a href="https://zeno.vision" target="_blank" rel="noopener">Zeno</a> · <a href="https://github.com/mbarbosa30/SelfClaw" target="_blank" rel="noopener">GitHub</a> · <a href="https://t.me/+GC2quXBnarw1MzU0" target="_blank" rel="noopener">Telegram</a></span>
      </div>
    </footer>
  </div>

  <script>
    var activityChart = null;

    var EVENT_COLORS = {
      verification: '#FF6B4A',
      wallet_creation: '#4AFF6B',
      token_deployment: '#6B4AFF',
      gas_request: '#FFD700',
      sponsorship: '#FF4A9E'
    };

    var FUNNEL_COLORS = {
      pending: '#FFD700',
      verified: '#22c55e',
      expired: '#8a8a8a',
      failed: '#ef4444'
    };

    function timeAgo(dateStr) {
      var now = new Date();
      var then = new Date(dateStr);
      var diff = Math.floor((now - then) / 1000);
      if (diff < 60) return diff + 's ago';
      diff = Math.floor(diff / 60);
      if (diff < 60) return diff + ' min ago';
      diff = Math.floor(diff / 60);
      if (diff < 24) return diff + 'h ago';
      diff = Math.floor(diff / 24);
      if (diff < 30) return diff + 'd ago';
      return Math.floor(diff / 30) + 'mo ago';
    }

    function setText(id, val) {
      var el = document.getElementById(id);
      if (el) el.textContent = val !== undefined && val !== null ? val : '\u2014';
    }

    function renderFunnel(funnel) {
      var bar = document.getElementById('funnel-bar');
      var legend = document.getElementById('funnel-legend');
      var total = (funnel.pending || 0) + (funnel.verified || 0) + (funnel.expired || 0) + (funnel.failed || 0);
      bar.innerHTML = '';
      legend.innerHTML = '';
      if (total === 0) {
        var empty = document.createElement('div');
        empty.className = 'funnel-segment';
        empty.style.flex = '1';
        empty.style.background = '#ddd';
        empty.style.color = '#999';
        empty.textContent = 'No data';
        bar.appendChild(empty);
        return;
      }
      var keys = ['pending', 'verified', 'expired', 'failed'];
      for (var i = 0; i < keys.length; i++) {
        var k = keys[i];
        var v = funnel[k] || 0;
        if (v === 0) continue;
        var pct = (v / total * 100);
        var seg = document.createElement('div');
        seg.className = 'funnel-segment';
        seg.style.flex = pct.toString();
        seg.style.background = FUNNEL_COLORS[k];
        seg.textContent = v;
        bar.appendChild(seg);

        var li = document.createElement('div');
        li.className = 'funnel-legend-item';
        var dot = document.createElement('span');
        dot.className = 'funnel-dot';
        dot.style.background = FUNNEL_COLORS[k];
        li.appendChild(dot);
        li.appendChild(document.createTextNode(k + ': ' + v));
        legend.appendChild(li);
      }
    }

    function renderChart(timeline) {
      var ctx = document.getElementById('activity-chart').getContext('2d');
      var labels = timeline.map(function(d) { return d.date.slice(5); });
      var types = ['verification', 'wallet_creation', 'token_deployment', 'gas_request', 'sponsorship'];
      var typeLabels = ['Verification', 'Wallet Creation', 'Token Deployment', 'Gas Request', 'Sponsorship'];
      var datasets = [];
      for (var i = 0; i < types.length; i++) {
        datasets.push({
          label: typeLabels[i],
          data: timeline.map(function(d) { return (d.events && d.events[types[i]]) || 0; }),
          backgroundColor: EVENT_COLORS[types[i]],
          borderWidth: 0,
          borderRadius: 2
        });
      }
      if (activityChart) activityChart.destroy();
      activityChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#5a5a5a',
                font: { family: 'IBM Plex Mono', size: 10 },
                boxWidth: 12,
                padding: 16
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: { color: '#8a8a8a', font: { family: 'IBM Plex Mono', size: 9 }, maxRotation: 45 },
              grid: { color: '#e8e8e8' }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: { color: '#8a8a8a', font: { family: 'IBM Plex Mono', size: 10 }, stepSize: 1 },
              grid: { color: '#e8e8e8' }
            }
          }
        }
      });
    }

    function renderFeed(items) {
      var list = document.getElementById('feed-list');
      if (!items || items.length === 0) {
        list.innerHTML = '<div class="feed-empty">No recent activity</div>';
        return;
      }
      var html = '';
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var color = EVENT_COLORS[item.eventType] || '#8a8a8a';
        var name = item.agentName || 'Unknown';
        var time = item.createdAt ? timeAgo(item.createdAt) : '';
        var typeLabel = (item.eventType || '').replace(/_/g, ' ');
        html += '<div class="feed-item">';
        html += '<span class="feed-dot" style="background:' + color + '"></span>';
        html += '<span class="feed-type">' + typeLabel + '</span>';
        html += '<span class="feed-agent">' + name + '</span>';
        html += '<span class="feed-time">' + time + '</span>';
        html += '</div>';
      }
      list.innerHTML = html;
    }

    function loadDashboard() {
      fetch('/api/selfclaw/v1/dashboard')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          setText('s-verified', data.registry ? data.registry.totalVerifiedAgents : '\u2014');
          setText('s-tokens', data.tokenEconomy ? data.tokenEconomy.tokensDeployed : '\u2014');
          setText('s-pools', data.tokenEconomy ? data.tokenEconomy.activePools : '\u2014');
          setText('s-sponsored', data.tokenEconomy ? data.tokenEconomy.sponsoredAgents : '\u2014');

          setText('w-total', data.wallets ? data.wallets.total : '\u2014');
          setText('w-gas', data.wallets ? data.wallets.gasSubsidies : '\u2014');
          setText('w-treasury', data.wallets ? data.wallets.treasuryBalance : '\u2014');

          if (data.verificationFunnel) renderFunnel(data.verificationFunnel);
          if (data.activityTimeline) renderChart(data.activityTimeline);
          if (data.recentActivity) renderFeed(data.recentActivity);

          var ts = data.generatedAt ? new Date(data.generatedAt).toLocaleTimeString() : 'now';
          document.getElementById('last-updated').textContent = 'Last updated: ' + ts;
        })
        .catch(function() {
          document.getElementById('last-updated').textContent = 'Error loading data';
          setText('s-verified', '\u2014');
          setText('s-tokens', '\u2014');
          setText('s-pools', '\u2014');
          setText('s-sponsored', '\u2014');
          setText('w-total', '\u2014');
          setText('w-gas', '\u2014');
          setText('w-treasury', '\u2014');
        });
    }

    loadDashboard();
    setInterval(loadDashboard, 30000);
  </script>
  <script src="/auth.js"></script>
  <script src="/nav-gate.js"></script>
  <script src="/dashboard-check.js"></script>
  <script src="/nav-toggle.js"></script>
</body>
</html>
