import { createPublicClient, createWalletClient, http, parseUnits, formatUnits, encodeDeployData, encodeFunctionData, getContractAddress } from 'viem';
import { celo } from 'viem/chains';
import { privateKeyToAccount } from 'viem/accounts';

const publicClient = createPublicClient({
  chain: celo,
  transport: http()
});

function createWalletFromKey(privateKey: string) {
  const formattedKey = privateKey.startsWith('0x') ? privateKey : `0x${privateKey}`;
  const account = privateKeyToAccount(formattedKey as `0x${string}`);
  const walletClient = createWalletClient({
    account,
    chain: celo,
    transport: http()
  });
  return { walletClient, account, address: account.address };
}

const SIMPLE_ERC20_BYTECODE = '0x608060405234801561001057600080fd5b50604051610a1e380380610a1e8339818101604052810190610032919061023a565b82600390816100419190610494565b5081600490816100519190610494565b508060058190555080600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555050505050610566565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61010e826100c5565b810181811067ffffffffffffffff8211171561012d5761012c6100d6565b5b80604052505050565b60006101406100a7565b905061014c8282610105565b919050565b600067ffffffffffffffff82111561016c5761016b6100d6565b5b610175826100c5565b9050602081019050919050565b60005b838110156101a0578082015181840152602081019050610185565b60008484015250505050565b60006101bf6101ba84610151565b610136565b9050828152602081018484840111156101db576101da6100c0565b5b6101e6848285610182565b509392505050565b600082601f830112610203576102026100bb565b5b81516102138482602086016101ac565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000806000606084860312156102705761026f6100b1565b5b600084015167ffffffffffffffff81111561028e5761028d6100b6565b5b61029a868287016101ee565b935050602084015167ffffffffffffffff8111156102bb576102ba6100b6565b5b6102c7868287016101ee565b92505060406102d88682870161022e565b9150509250925092565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061033457607f821691505b602082108103610347576103466102ed565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026103af7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610372565b6103b98683610372565b95508019841693508086168417925050509392505050565b6000819050919050565b60006103f66103f16103ec8461023c565b6103d1565b61023c565b9050919050565b6000819050919050565b610410836103db565b61042461041c826103fd565b84845461037f565b825550505050565b600090565b61043961042c565b610444818484610407565b505050565b5b818110156104685761045d600082610431565b60018101905061044a565b5050565b601f8211156104ad5761047e8161034d565b61048784610362565b81016020851015610496578190505b6104aa6104a285610362565b830182610449565b50505b505050565b600082821c905092915050565b60006104d0600019846008026104b2565b1980831691505092915050565b60006104e983836104bf565b9150826002028217905092915050565b610502826102e2565b67ffffffffffffffff81111561051b5761051a6100d6565b5b610525825461031c565b61053082828561046c565b600060209050601f8311600181146105635760008415610551578287015190505b61055b85826104dd565b8655506105c3565b601f1984166105718661034d565b60005b8281101561059957848901518255600182019150602085019450602081019050610574565b868310156105b657848901516105b2601f8916826104bf565b8355505b6001600288020188555050505b505050505050565b6104a9806105756000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c806306fdde0314610067578063095ea7b31461008557806318160ddd146100b557806323b872dd146100d357806370a0823114610103578063a9059cbb14610133575b600080fd5b61006f610163565b60405161007c9190610342565b60405180910390f35b61009f600480360381019061009a91906103f7565b6101f5565b6040516100ac9190610452565b60405180910390f35b6100bd6102e7565b6040516100ca919061047c565b60405180910390f35b6100ed60048036038101906100e89190610497565b6102ed565b6040516100fa9190610452565b60405180910390f35b61011d600480360381019061011891906104ea565b61030c565b60405161012a919061047c565b60405180910390f35b61014d600480360381019061014891906103f7565b610324565b60405161015a9190610452565b60405180910390f35b6060600380546101729061054d565b80601f016020809104026020016040519081016040528092919081815260200182805461019e9061054d565b80156101eb5780601f106101c0576101008083540402835291602001916101eb565b820191906000526020600020905b8154815290600101906020018083116101ce57829003601f168201915b5050505050905090565b600081600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516102d5919061047c565b60405180910390a36001905092915050565b60055481565b600080336040516102fd906107a6565b5050505050505050505050565b60026020528060005260406000206000915090505481565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036103925760006103858361037f565b60059190610324565b61038e57600080fd5b5050600190565b81600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410156103e257600080fd5b81600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546104319190610585565b9250508190555081600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546104879190610585565b925050819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516104eb919061047c565b60405180910390a36001905092915050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561053757808201518184015260208101905061051c565b60008484015250505050565b6000601f19601f8301169050919050565b600061055f826104fd565b6105698185610508565b9350610579818560208601610519565b61058281610543565b840191505092915050565b60006020820190508181036000830152610342816105548061054d565b8060005b838110156105c3578082015181840152602081019050610581565b50505060009050810190565b60006020828403121561061e5761061d600080fd5b5b600082013567ffffffffffffffff81111561063c5761063b600080fd5b5b6106488482850161060e565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061067c82610651565b9050919050565b61068c81610671565b811461069757600080fd5b50565b6000813590506106a981610683565b92915050565b6000819050919050565b6106c2816106af565b81146106cd57600080fd5b50565b6000813590506106df816106b9565b92915050565b600080604083850312156106fc576106fb600080fd5b5b600061070a8582860161069a565b925050602061071b858286016106d0565b9150509250929050565b60008115159050919050565b61073a81610725565b82525050565b60006020820190506107556000830184610731565b92915050565b610764816106af565b82525050565b600060208201905061077f600083018461075b565b92915050565b60008060006060848603121561079e5761079d600080fd5b5b60006107ac8682870161069a565b93505060206107bd8682870161069a565b92505060406107ce868287016106d0565b9150509250925092565b6000602082840312156107ee576107ed600080fd5b5b60006107fc8482850161069a565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061083f826106af565b915061084a836106af565b925082820190508082111561086257610861610805565b5b9291505056fea2646970667358221220' as `0x${string}`;

const SIMPLE_ERC20_ABI = [
  { name: 'name', type: 'function', stateMutability: 'view', inputs: [], outputs: [{ name: '', type: 'string' }] },
  { name: 'symbol', type: 'function', stateMutability: 'view', inputs: [], outputs: [{ name: '', type: 'string' }] },
  { name: 'decimals', type: 'function', stateMutability: 'view', inputs: [], outputs: [{ name: '', type: 'uint8' }] },
  { name: 'totalSupply', type: 'function', stateMutability: 'view', inputs: [], outputs: [{ name: '', type: 'uint256' }] },
  { name: 'balanceOf', type: 'function', stateMutability: 'view', inputs: [{ name: 'account', type: 'address' }], outputs: [{ name: '', type: 'uint256' }] },
  { name: 'transfer', type: 'function', stateMutability: 'nonpayable', inputs: [{ name: 'to', type: 'address' }, { name: 'amount', type: 'uint256' }], outputs: [{ name: '', type: 'bool' }] },
  { name: 'approve', type: 'function', stateMutability: 'nonpayable', inputs: [{ name: 'spender', type: 'address' }, { name: 'amount', type: 'uint256' }], outputs: [{ name: '', type: 'bool' }] },
  { name: 'allowance', type: 'function', stateMutability: 'view', inputs: [{ name: 'owner', type: 'address' }, { name: 'spender', type: 'address' }], outputs: [{ name: '', type: 'uint256' }] },
  { name: 'transferFrom', type: 'function', stateMutability: 'nonpayable', inputs: [{ name: 'from', type: 'address' }, { name: 'to', type: 'address' }, { name: 'amount', type: 'uint256' }], outputs: [{ name: '', type: 'bool' }] },
] as const;

const OPENZEPPELIN_ERC20_BYTECODE = '0x60806040523480156200001157600080fd5b5060405162000e9938038062000e99833981810160405281019062000037919062000277565b8282600390816200004991906200052f565b5081600490816200005b91906200052f565b505080600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550620000ae81826200012160201b60201c565b50505050620006db565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036200012b5760006040517fec442f050000000000000000000000000000000000000000000000000000000081526004016200012291906200063d565b60405180910390fd5b6200013f600083836200014360201b60201c565b5050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603620001975780600260008282546200018c91906200068a565b925050819055506200026f565b6000806000858152602001908152602001600020549050818110156200020f578381836040517fe450d38c000000000000000000000000000000000000000000000000000000008152600401620002029493929190620006d6565b60405180910390fd5b8181036000808681526020019081526020016000208190555050600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16146200026d57806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055505b505b505050565b6000806000606084860312156200028f576200028e6200071d565b5b600084015167ffffffffffffffff811115620002b057620002af62000722565b5b620002be868287016200077b565b935050602084015167ffffffffffffffff811115620002e257620002e162000722565b5b620002f0868287016200077b565b9250506040620003038682870162000813565b9150509250925092565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200038f57607f821691505b602082108103620003a557620003a462000347565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026200040f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620003d0565b6200041b8683620003d0565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600062000468620004626200045c8462000433565b6200043d565b62000433565b9050919050565b6000819050919050565b620004848362000447565b6200049c62000493826200046f565b848454620003dd565b825550505050565b600090565b620004b3620004a4565b620004c081848462000479565b505050565b5b81811015620004e857620004dc600082620004a9565b600181019050620004c6565b5050565b601f82111562000537576200050181620003ab565b6200050c84620003c0565b810160208510156200051c578190505b620005346200052b85620003c0565b830182620004c5565b50505b505050565b81516001600160401b0381111562000558576200055762000318565b5b62000570816200056984546200037b565b84620004ec565b602080601f831160018114620005a8576000841562000591578587015190505b6200059d8582620006cb565b865550620005f5565b601f198416620005b686620003ab565b60005b82811015620005e057848901518255600182019150602085019450602081019050620005b9565b86831015620005ff5784890151620005fb601f891682620006a3565b8355505b6001600288020188555050505b505050505050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200064182620006147565b9050919050565b62000653816200063d565b82525050565b6000602082019050620006706000830184620006485b92915050565b6000620006858262000433565b91506200069283620000433565b9250828201905080821115620006ad57620006ac6200065b565b5b92915050565b600082601f830112620006cb57620006ca62000722565b5b81516001600160401b03811115620006e857620006e762000318565b5b6200070b601f19601f8401166020016200077b565b915050929150506200078f565b600080fd5b600080fd5b600080fd5b600080fd5b60006200073e601f19601f8401166020016200077b565b9050919050565b82818337600083830152505050565b600062000766620007608462000433565b620007e8565b905092915050565b6000820190508381116200078f5762000788600082620007b8565b5b50600001919050565b6107ae80620006eb6000396000f3fe' as `0x${string}`;

export interface TokenInfo {
  address: string;
  name: string;
  symbol: string;
  decimals: number;
  totalSupply: string;
  creatorAddress: string;
}

export interface DeployTokenResult {
  success: boolean;
  tokenAddress?: string;
  txHash?: string;
  tokenInfo?: TokenInfo;
  error?: string;
}

export interface TransferTokenResult {
  success: boolean;
  txHash?: string;
  amount?: string;
  toAddress?: string;
  error?: string;
}

export interface TokenBalance {
  tokenAddress: string;
  symbol: string;
  name: string;
  balance: string;
  formattedBalance: string;
  decimals: number;
}

export async function deployERC20Token(
  platformPrivateKey: string,
  agentId: string,
  name: string,
  symbol: string,
  initialSupply: string,
  decimals: number = 18
): Promise<DeployTokenResult> {
  try {
    const wallet = createWalletFromKey(platformPrivateKey);
    
    const supplyWithDecimals = parseUnits(initialSupply, decimals);
    
    const factoryBytecode = `0x608060405234801561001057600080fd5b506040516106e03803806106e083398101604081905261002f9161011c565b8251610042906003906020860190610076565b508151610056906004906020850190610076565b50600581905533600090815260026020526040902055506101ca565b828054610082906101cf565b90600052602060002090601f0160209004810192826100a457600085556100ea565b82601f106100bd57805160ff19168380011785556100ea565b828001600101855582156100ea579182015b828111156100ea5782518255916020019190600101906100cf565b506100f69291506100fa565b5090565b5b808211156100f657600081556001016100fb565b634e487b7160e01b600052604160045260246000fd5b60008060006060848603121561013157600080fd5b83516001600160401b038082111561014857600080fd5b818601915086601f83011261015c57600080fd5b81518181111561016e5761016e61010f565b604051601f8201601f19908116603f011681019083821181831017156101965761019661010f565b816040528281526020935089848487010111156101b257600080fd5b600091505b828210156101d457848201840151818301850152908301906101b7565b828211156101e55760008484830101525b80975050505050602086015193506040860151925050509250925092565b600181811c90821680610217576003831691505b6020821081141561023857634e487b7160e01b600052602260045260246000fd5b50919050565b610507806102396000396000f3fe608060405234801561001057600080fd5b50600436106100725760003560e01c806370a082311161005057806370a08231146100d8578063a9059cbb14610101578063dd62ed3e1461011457600080fd5b806306fdde0314610077578063095ea7b31461009557806318160ddd146100b8575b600080fd5b61007f61014d565b60405161008c91906103b8565b60405180910390f35b6100a86100a336600461042c565b6101df565b604051901515815260200161008c565b6100c060055481565b60405190815260200161008c565b6100c06100e6366004610456565b6001600160a01b031660009081526002602052604090205490565b6100a861010f36600461042c565b6101f6565b6100c0610122366004610478565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b60606003805461015c906104ab565b80601f0160208091040260200160405190810160405280929190818152602001828054610188906104ab565b80156101d55780601f106101aa576101008083540402835291602001916101d5565b820191906000526020600020905b8154815290600101906020018083116101b857829003601f168201915b5050505050905090565b60006101ec33848461027e565b5060015b92915050565b600061020333848461028b565b6001600160a01b03841660009081526001602090815260408083203384529091528120805484929061023690849061040a565b909155506101ec9050576101ec565b60006040518060400160405280600681526020016553796d626f6c60d01b81525061026e91906102e7565b6000604051806040016040528060048152602001634e616d6560e01b815250610295919061032a565b9050919050565b6001600160a01b0382166102ec5760405163ec442f0560e01b8152600060048201526024015b60405180910390fd5b6102f760008383610336565b5050565b60008351116103435760405162461bcd60e51b81526020600482015260146024820152734e616d652063616e6e6f7420626520656d70747960601b60448201526064016102e3565b6001600160a01b03821660009081526002602052604090205461036790829061040a565b6001600160a01b038316600090815260026020526040902055805160058054919291839190610395906104ab565b9050816103a0906104ab565b81106103b1576103af826104ab565b505b5050505050565b600060208083528351808285015260005b818110156103e5578581018301518582016040015282016103c9565b818111156103f7576000604083870101525b50601f01601f1916929092016040019392505050565b8082018082111561042657634e487b7160e01b600052601160045260246000fd5b92915050565b6000806040838503121561043f57600080fd5b8235915060208301356001600160a01b038116811461045d57600080fd5b809150509250929050565b60006020828403121561047a57600080fd5b81356001600160a01b038116811461049157600080fd5b9392505050565b6000806040838503121561048b57600080fd5b82356001600160a01b03811681146104a257600080fd5b946020939093013593505050565b600181811c908216806104bf57607f821691505b6020821081036104df57634e487b7160e01b600052602260045260246000fd5b5091905056fea26469706673582212` as `0x${string}`;
    
    const abiEncodedArgs = encodeFunctionData({
      abi: [{
        name: 'constructor',
        type: 'constructor',
        inputs: [
          { name: '_name', type: 'string' },
          { name: '_symbol', type: 'string' },
          { name: '_initialSupply', type: 'uint256' }
        ]
      }],
      functionName: 'constructor',
      args: [name, symbol, supplyWithDecimals]
    }).slice(10);
    
    const deployData = (factoryBytecode + abiEncodedArgs) as `0x${string}`;
    
    const nonce = await publicClient.getTransactionCount({ address: wallet.address });
    
    const predictedAddress = getContractAddress({
      from: wallet.address,
      nonce: BigInt(nonce)
    });
    
    const hash = await wallet.walletClient.sendTransaction({
      data: deployData,
      gas: 2000000n,
    });
    
    const receipt = await publicClient.waitForTransactionReceipt({ hash });
    
    if (receipt.status !== 'success' || !receipt.contractAddress) {
      return { success: false, error: 'Contract deployment failed' };
    }
    
    const tokenInfo: TokenInfo = {
      address: receipt.contractAddress,
      name,
      symbol,
      decimals,
      totalSupply: initialSupply,
      creatorAddress: wallet.address
    };
    
    return {
      success: true,
      tokenAddress: receipt.contractAddress,
      txHash: hash,
      tokenInfo
    };
  } catch (error: any) {
    console.error('[token-factory] Deploy error:', error);
    return { success: false, error: error.message };
  }
}

export async function transferToken(
  platformPrivateKey: string,
  agentId: string,
  tokenAddress: string,
  toAddress: string,
  amount: string
): Promise<TransferTokenResult> {
  try {
    const wallet = createWalletFromKey(platformPrivateKey);
    
    const decimals = await publicClient.readContract({
      address: tokenAddress as `0x${string}`,
      abi: SIMPLE_ERC20_ABI,
      functionName: 'decimals'
    });
    
    const amountParsed = parseUnits(amount, decimals);
    
    const data = encodeFunctionData({
      abi: SIMPLE_ERC20_ABI,
      functionName: 'transfer',
      args: [toAddress as `0x${string}`, amountParsed]
    });
    
    const hash = await wallet.walletClient.sendTransaction({
      to: tokenAddress as `0x${string}`,
      data,
      gas: 100000n,
    });
    
    const receipt = await publicClient.waitForTransactionReceipt({ hash });
    
    if (receipt.status !== 'success') {
      return { success: false, error: 'Token transfer failed' };
    }
    
    return {
      success: true,
      txHash: hash,
      amount,
      toAddress
    };
  } catch (error: any) {
    console.error('[token-factory] Transfer error:', error);
    return { success: false, error: error.message };
  }
}

export async function getTokenBalance(
  tokenAddress: string,
  walletAddress: string
): Promise<TokenBalance | null> {
  try {
    const [balance, symbol, name, decimals] = await Promise.all([
      publicClient.readContract({
        address: tokenAddress as `0x${string}`,
        abi: SIMPLE_ERC20_ABI,
        functionName: 'balanceOf',
        args: [walletAddress as `0x${string}`]
      }),
      publicClient.readContract({
        address: tokenAddress as `0x${string}`,
        abi: SIMPLE_ERC20_ABI,
        functionName: 'symbol'
      }),
      publicClient.readContract({
        address: tokenAddress as `0x${string}`,
        abi: SIMPLE_ERC20_ABI,
        functionName: 'name'
      }),
      publicClient.readContract({
        address: tokenAddress as `0x${string}`,
        abi: SIMPLE_ERC20_ABI,
        functionName: 'decimals'
      })
    ]);
    
    return {
      tokenAddress,
      symbol,
      name,
      balance: balance.toString(),
      formattedBalance: formatUnits(balance, decimals),
      decimals
    };
  } catch (error: any) {
    console.error('[token-factory] Get balance error:', error);
    return null;
  }
}

export async function getMultipleTokenBalances(
  tokenAddresses: string[],
  walletAddress: string
): Promise<TokenBalance[]> {
  const balances = await Promise.all(
    tokenAddresses.map(addr => getTokenBalance(addr, walletAddress))
  );
  return balances.filter((b): b is TokenBalance => b !== null);
}

export async function getTokenInfo(tokenAddress: string): Promise<TokenInfo | null> {
  try {
    const [name, symbol, totalSupply, decimals] = await Promise.all([
      publicClient.readContract({
        address: tokenAddress as `0x${string}`,
        abi: SIMPLE_ERC20_ABI,
        functionName: 'name'
      }),
      publicClient.readContract({
        address: tokenAddress as `0x${string}`,
        abi: SIMPLE_ERC20_ABI,
        functionName: 'symbol'
      }),
      publicClient.readContract({
        address: tokenAddress as `0x${string}`,
        abi: SIMPLE_ERC20_ABI,
        functionName: 'totalSupply'
      }),
      publicClient.readContract({
        address: tokenAddress as `0x${string}`,
        abi: SIMPLE_ERC20_ABI,
        functionName: 'decimals'
      })
    ]);
    
    return {
      address: tokenAddress,
      name,
      symbol,
      decimals,
      totalSupply: formatUnits(totalSupply, decimals),
      creatorAddress: ''
    };
  } catch (error: any) {
    console.error('[token-factory] Get token info error:', error);
    return null;
  }
}
